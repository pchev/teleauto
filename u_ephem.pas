unit u_ephem;

{
Copyright (C) Philippe Martinole

http://www.teleauto.org/
philippe.martinole@teleauto.org

This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License
as published by the Free Software Foundation; either version 2
of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
}

interface

uses SysUtils;

function  jj(DT:TDateTime):Double;
procedure JupPhys(qu:TDateTime;var ad,dc,aph,lc1,lc2,bc,dae,dap,th0,ap,Apl:double);
procedure MarsPhys(qu:TDateTime;var ad,dc,aph,lc,bc,dae,dap,th0,ap,Apl:double);
procedure SatPhys(qu:TDateTime;var ad,dc,aph,lc1,lc2,bc,dae,dap,th0,ap,Apl:double);

implementation

const
 UA=149597870.691;
 REQT=6378.137;
 MAXITER=4;
 VLM=299792.458;
 JLM=86400*VLM;

var
 sem:array[0..6] of string[8];
 mth:array[1..12] of string[9];

function jj(DT:TDateTime):Double;
var
 x,y,wrk:Double;
 Year,Month,day,Hour,Min,Sec,MSec:Word;
begin
 DecodeDate(DT,Year,Month,Day);
 DecodeTime(DT,Hour,Min,Sec,MSec);
 wrk:=((Year*100+Month)*100+Day)/10000;
 x:=Year;
 y:=Month+1;
 if (Month<3) then
  begin
   x:=x-1;
   y:=y+12;
  end;
 if (wrk<1582.1015) then wrk:=0 else wrk:=2-int(x/100)+int(x/400);
 wrk:=wrk+Day+int(30.6001*y);
 if (x<0) then wrk:=wrk+int(365.25*x-0.75) else wrk:=wrk+int(365.25*x);
 jj:=1720994.5+wrk+((Hour*60+Min)*60+Sec)/86400.0;
end;

procedure CalcNut(t:Double;var deps,dpsi:Double);
var
m0,m9,f,d,om:Double;
begin
 m9:=485867.28096+t*(17179159234.728+t*(3238.93+t*(51.651-2.44*t)));
 m0:=1287104.79306+t*(1295965810.474+t*(0.147*t-55.29));
 f:=335779.55755+t*(17395272630.983-t*(1225.05+t*(1.021-t*0.0417)));
 d:=1072260.73512+t*(16029616014.603-t*(586.81-t*(6.595-0.3184*t)));
 om:=450160.39816-t*(69628902.656-t*(747.42+t*(7.702-t*0.5939)));
 m9:=pi*(m9-1296000.0*int(m9/1296000.0))/648000;
 m0:=pi*(m0-1296000.0*int(m0/1296000.0))/648000;
 f:=pi*(f-1296000.0*int(f/1296000.0))/648000;
 d:=pi*(d-1296000.0*int(d/1296000.0))/648000;
 om:=pi*(om-1296000.0*int(om/1296000.0))/648000;
 dpsi:=-(171996+1742*t)*sin(om)+(2062+2*t)*sin(2*om);
 dpsi:=dpsi+46*sin(2*(f-m9)+om)+11*sin(2*(m9-f));
 dpsi:=dpsi-(13187+16*t)*sin(2*(f-d+om))+(1426-34*t)*sin(m0);
 dpsi:=dpsi-(517-12*t)*sin(m0+2*(f-d+om));
 dpsi:=dpsi+(217-5*t)*sin(2*(f-d+om)-m0);
 dpsi:=dpsi+(129+t)*sin(2*(f-d)+om)+48*sin(2*(m9-d));
 dpsi:=dpsi-22*sin(2*(f-d))+(17-t)*sin(2*m0)-15*sin(m0+om);
 dpsi:=dpsi-(16-t)*sin(2*(m0+f-d+om))-12*sin(om-m0);
 dpsi:=dpsi-(2274+2*t)*sin(2*(f+om))+(712+t)*sin(m9);
 dpsi:=dpsi-(386+4*t)*sin(2*f+om)-301*sin(m9+2*(f+om));
 dpsi:=dpsi-158*sin(m9-2*d)+123*sin(2*(f+om)-m9)+63*sin(2*d);
 dpsi:=dpsi+(63+t)*sin(m9+om)-(58+t)*sin(om-m9);
 dpsi:=dpsi-59*sin(2*(f+d+om)-m9)-51*sin(m9+2*f+om);
 dpsi:=dpsi-38*sin(2*(f+d+om))+29*sin(2*m9)+29*sin(m9+2*(f-d+om));
 dpsi:=dpsi-31*sin(2*(m9+f+om))+26*sin(2*f)+21*sin(2*f+om-m9);
 dpsi:=dpsi+16*sin(2*d+om-m9)-13*sin(m9-2*d+om);
 dpsi:=dpsi-10*sin(2*(f+d)+om-m9)-8*sin(m9+2*(f+d+om));
 dpsi:=dpsi+7*(sin(m0+2*(f+om))+sin(-m0+2*(f+om))-sin(m9+m0-2*d)-sin(2*(f+d)+om));
 dpsi:=dpsi+6*(sin(m9+2*d)+sin(2*(m9+f-d-om))-sin(2*d+om)+sin(m9+2*(f-d)+om)-sin(+2*(d-m9)+om));
 dpsi:=dpsi+5*(sin(m9-m0)-sin(om-2*d)-sin(2*(m9+f)+om)-sin(2*(f-d)+om-m0));
 dpsi:=dpsi+4*(sin(2*(m9-d)+om)+sin(m0+om+2*(f-d))-sin(m9-d));
 dpsi:=dpsi+4*(sin(m9-2*f)-sin(m0-2*d)-sin(d)-sin(2*(f+om-m9))-sin(m9-m0-d));
 dpsi:=dpsi+3*(sin(m9+2*f)-sin(m9+m0)-sin(m9-m0+2*(f+om)));
 dpsi:=dpsi-3*(sin(2*(f+d+om)-m9-m0)+sin(3*m9+2*(f+om))+sin(2*(f+d+om)-m0));
 dpsi:=dpsi+2*(sin(m9+m0+2*(f+om))-sin(2*(f-d)+om-m9)-sin(om-2*m9));
 dpsi:=dpsi+2*(sin(2*m9+om)-sin(4*d+2*(om+f)-m9)-sin(m9+2*om));
 dpsi:=dpsi+2*(sin(3*m9)+sin(2*(f+om)+d)-sin(2*(f-m0-d)+om));
 dpsi:=dpsi+sin(2*(m9-d)+m0)+sin(2*(d-f)+om)-sin(m0+2*(d-f));
 dpsi:=dpsi+sin(m0+2*om)+sin(d-m9+om)-sin(m0+2*(f-d));
 dpsi:=dpsi+sin(2*om-m9)-sin(m9-4*d)+sin(2*(f+d+om-m9))-sin(2*m9-4*d);
 dpsi:=dpsi+sin(m9+m0+2*(f-d+om))-sin(m9+om+2*(f+d))-sin(2*(2*d+om+f-m9));
 dpsi:=dpsi+sin(4*f+2*om-m9)+sin(m9-m0-2*d)+sin(2*(m9+f-d)+om);
 dpsi:=dpsi-sin(2*(m9+f+d+om))-sin(m9+2*d+om)+sin(2*(2*f-d+om));
 dpsi:=dpsi+sin(3*m9+2*(f-d+om))-sin(m9+2*(f-d))+sin(m0+2*f+om);
 dpsi:=dpsi+sin(2*d+om-m9-m0)-sin(om-2*f)-sin(2*(f+om)-d);
 dpsi:=dpsi-sin(m0+2*d)-sin(m9-2*(f+d))-sin(2*f+om-m0)+sin(2*(m9-f)+om);
 dpsi:=dpsi+sin(2*(m9+d))-sin(m9+m0+om-2*d)-sin(m9+2*(d-f));
 dpsi:=dpsi+sin(m0+d)-sin(2*(2*d+f+om));
 dpsi:=10*dpsi-sin(3*m9+2*(f+d+om))-2*sin(m9+2*(f+om+2*d))-3*sin(4*m9+2*(f+om));
 dpsi:=dpsi-2*sin(2*(m9+f+d)+om)-sin(2*f+4*d+om)-5*sin(3*m9+2*f+om);
 dpsi:=dpsi+sin(m9+m0+2*(f+d+om))-6*sin(m9-m0+2*(f+d+om))-3*sin(2*f+4*d+om-m9);
 dpsi:=dpsi-2*sin(2*(f+om+2*d)-m9-m0)+4*sin(2*(m9+f+om)+m0)+2*sin(4*f-2*om);
 dpsi:=dpsi+3*sin(2*(m9+f))+5*sin(m0+2*(f+d+om))+3*sin(m9+d+2*(f+om));
 dpsi:=dpsi-5*sin(2*(m9+f+om)-m0)+4*sin(2*(f+d))-sin(2*(m9+d)-om);
 dpsi:=dpsi-4*sin(2*(f+d)+om-m0)-2*sin(4*d+2*(f-m9)+om)-sin(2*(om+d+f-m0));
 dpsi:=dpsi+5*sin(4*d)-2*sin(4*d+om)+2*sin(4*f+2*(om-d)+m9);
 dpsi:=dpsi+2*sin(3*m9+2*(f-d)+om)+4*sin(2*f+m0+m9+om)+2*sin(4*f+om-m9);
 dpsi:=dpsi-2*sin(2*(f+om)+m0+d)-sin(om-3*m9)+6*sin(2*(f+d+om)+m0-m9);
 dpsi:=dpsi+3*sin(2*f+d+om)-4*sin(m9-m0+2*f+om)-4*sin(om-m9-2*d);
 dpsi:=dpsi-5*sin(2*(f+d)+om-m9-m0)+5*sin(m9-m0+2*d)-sin(m9-4*d+om);
 dpsi:=dpsi-2*sin(4*d+om-m9)+sin(4*d-m9-m0)+3*sin(2*(m9+f-d+om)+m0);
 dpsi:=dpsi+2*sin(4*f-2*d+om)-3*sin(m9-d+2*(f+om))-3*sin(2*m9+m0)-sin(2*f+om);
 dpsi:=dpsi+2*sin(2*f+3*om)+2*sin(m0+om+2*d)-3*sin(m9+d)+4*sin(2*m9-m0);
 dpsi:=dpsi+2*sin(2*(f+d-m9)+om)+sin(2*(om-d))-5*sin(2*(d+om));
 dpsi:=dpsi-3*sin(m0+om-2*d)-2*sin(2*d+om-m0)-sin(2*m9-4*d+om);
 dpsi:=dpsi+sin(4*d-2*m9+om)+2*sin(2*(d-m0))-sin(2*f-4*d+om);
 dpsi:=dpsi+3*sin(m9+m0+om+2*(f-d))+4*sin(2*(f+om)+m0-m9)+2*sin(om-m9-m0);
 dpsi:=dpsi-3*sin(m9+m0+om)+3*sin(m9-2*f+om)-2*sin(f+om);
 dpsi:=dpsi-2*sin(2*(f+om)-m9-m0)-sin(2*d+om-m9+m0)+3*sin(om-d);
 dpsi:=dpsi-4*sin(d+om)-2*sin(m0+om-m9)+5*sin(m9-m0+om)+3*sin(m9+2*(om-d));
 dpsi:=dpsi-4*sin(2*(d+om)-m9)+3*sin(2*(om+f-d)-m9)-sin(2*(f-d)+om+m0-m9);
 dpsi:=dpsi+3*sin(2*(d-m0)-m9)-4*sin(m9+om+2*f-4*d)-5*sin(3*m0+2*(f+om-d));
 dpsi:=dpsi+3*sin(3*m0)-2*sin(2*(d-m9)+om-m0)-9*sin(2*(f-d)+om)-sin(om-2*m0);
 dpsi:=dpsi+12*sin(2*(f-d)+3*om)-3*sin(2*(m9+om-d))-sin(om+m0+2*(f-m9));
 dpsi:=dpsi-sin(m0+2*(f+om-m9))-4*sin(2*f-d-m9+om)+3*sin(2*om-m0);
 dpsi:=dpsi+2*sin(m9-d+om)+4*sin(2*(f+om-m9)-m0)+4*sin(2*(f-m9)+om-m0);
 dpsi:=dpsi+2*sin(2*(f+om)+d-3*m9)-2*sin(3*om)+13*sin(2*(f+om)-m9-m0-d);
 dpsi:=dpsi-15*sin(f+om-m9)+3*sin(f-m9+2*om)+7*sin(m0-m9+d+om);
 dpsi:=dpsi-sin(2*(m9+f+d+om)-m0)-sin(4*d+2*(om+f)-m0)-sin(3*m9+2*(f+om)-m0);
 dpsi:=dpsi-sin(2*(f+d-m0)+om+m9)+sin(m9+4*d)+sin(4*m9+2*(f+om-d));
 dpsi:=dpsi+sin(2*(m9+f)+m0+om)+sin(4*m9)+sin(m0+om+2*(f+d))+sin(m9+d+om+2*f);
 dpsi:=dpsi-sin(2*(m9+f)+om-m0)+sin(2*(f+om)+3*d-m9)-sin(4*d+2*(f+om-m9)-m0);
 dpsi:=dpsi+sin(4*d-m0)-sin(2*(m9+f+om)-d)+sin(m9-om+2*f)+sin(3*m9+om);
 dpsi:=dpsi+sin(2*(f+d)+om-m9+m0)-sin(m9+m0+2*d)-sin(m9-m0+om+2*d);
 dpsi:=dpsi-sin(2*(f+d+om-m0)-m9)+sin(2*(m9+f-d)+om+m0)+sin(2*(m0+f+om));
 dpsi:=dpsi-sin(2*(m9+f-d))-sin(4*f+2*(om-m9))+sin(m9+m0+d)-sin(2*(m9+om));
 dpsi:=dpsi+sin(2*(f+om)+d-m9)-sin(2*d+m0-om)-sin(2*(f+om-m0));
 dpsi:=dpsi+sin(2*(m9+d-f)-om)+sin(2*(f+d+om-m9)-m0)-sin(3*d-m9);
 dpsi:=dpsi+sin(4*d-2*m9-m0)-sin(4*f+2*(om-d)-m9)-sin(m9+2*m0);
 dpsi:=dpsi+sin(2*f+om-m9+m0)-sin(2*f-d+om)-sin(m9-m0+om+2*(f-d));
 dpsi:=dpsi-sin(m9-m0+2*(f+om-d))+sin(2*m9-d)-sin(2*(m0+d)-m9);
 dpsi:=dpsi+sin(2*(f+om)-m0-d)+sin(3*m9-2*f-om)-sin(2*f-m9-m0+om);
 dpsi:=dpsi-sin(2*d-m9+m0-om)+sin(2*(f+d)-3*m9+om)+sin(m9-2*m0)-sin(3*d-2*m9);
 dpsi:=dpsi+sin(4*d-3*m9)-sin(4*d-2*(f+om)-m9)-sin(4*d-2*f-m9);
 dpsi:=dpsi+sin(4*d-2*(f+om)-m9-m0)-sin(m9+m0+om+2*f-4*d)+sin(2*(m0+f-d)+om);
 dpsi:=dpsi-sin(2*(m9+f+om)-4*d)+sin(2*(m9-d)+m0+om)-sin(4*f+2*(om-m9-d));
 dpsi:=dpsi-sin(2*(m0+f+om-m9))-sin(2*m0+om)+sin(m9-m0+2*(f+om)-3*d);
 dpsi:=dpsi-sin(2*(f+d+om)-4*m9);
 deps:=(92025+89*t)*cos(om)-(895-5*t)*cos(2*om)-24*cos(2*(f-m9)+om);
 deps:=deps+(5736-31*t)*cos(2*(f-d+om))+(54-t)*cos(m0);
 deps:=deps+(224-6*t)*cos(m0+2*(f-d+om))-(95-3*t)*cos(2*(f-d+om)-m0);
 deps:=deps-70*cos(2*(f-d)+om)+(977-5*t)*cos(2*(f+om))-7*cos(m9);
 deps:=deps+(200-t)*cos(2*f+om)+129*cos(m9+2*(f+om))-cos(m9-2*d);
 deps:=deps-53*cos(2*(f+om)-m9)-33*cos(m9+om)+32*cos(om-m9);
 deps:=deps+26*cos(2*(f+d+om)-m9)+27*cos(m9+2*f+om)+16*cos(2*(f+d+om));
 deps:=deps-cos(2*m9)-12*cos(m9+2*(f-d+om))+13*cos(2*(m9+f+om))-cos(2*f);
 deps:=deps-10*cos(2*f+om-m9)+9*cos(m0+om)-8*cos(2*d+om-m9)+6*cos(om-m0);
 deps:=deps+7*(cos(m9-2*d+om)+cos(2*(m0+f-d+om)));
 deps:=deps+5*(cos(2*(f+d)+om-m9)+cos(m9+m0-2*d));
 deps:=deps+3*(cos(m9+2*(f+d+om))+cos(m9+2*d)+cos(2*(f+d)+om));
 deps:=deps+3*(cos(m9+2*(f-d)+om)+cos(m9-m0)+cos(m0-2*d));
 deps:=deps+3*(cos(2*(d-m9)+om)+cos(2*(f-d)+om-m0));
 deps:=deps-3*(cos(2*(f+om)-m0)+cos(2*d+om)+cos(om-2*d));
 deps:=deps-2*(cos(2*(m9-d)+om)+cos(m0+2*(f-d)+om)-cos(2*d));
 deps:=deps+cos(2*(f-d-m0)+om)+cos(2*(f+om-m9))+cos(2*(m9-d));
 deps:=deps+cos(m9-m0+2*(f+om))+cos(2*(f+d+om)-m9-m0);
 deps:=deps+cos(om-2*m9)+cos(3*m9+2*(f+om))+cos(2*(f+d+om)-m0);
 deps:=deps-cos(m9+m0+2*(f+om))+cos(2*(f-d)+om-m9)-cos(2*m9+om);
 deps:=deps+cos(m9+2*om)-cos(2*(f+om)+d)-cos(2*om-m9)-cos(2*(f+d+om-m9));
 deps:=deps+cos(2*(2*d+f+om)-m9)-cos(m9+m0+2*(f-d+om))+cos(2*(f+d)+m9+om);
 deps:=deps+cos(2*(2*d-m9+f+om))-cos(2*(m9+f-d)+om);
 deps:=10*deps+cos(3*m9+2*(f+d+om))+cos(m9+2*(f+om+2*d))+cos(4*m9+2*(f+om));
 deps:=deps+cos(2*(m9+f+d)+om)+cos(2*f+4*d+om)+2*cos(3*m9+2*f+om);
 deps:=deps-cos(m9+m0+2*(f+d+om))+2*cos(m9-m0+2*(f+d+om))+cos(2*f+4*d+om-m9);
 deps:=deps+cos(2*(f+om+2*d)-m9-m0)-2*cos(2*(m9+f+om)+m0)-cos(4*f-2*om);
 deps:=deps-2*cos(m0+2*(f+d+om))-cos(m9+d+2*(f+om))+2*cos(2*(m9+f+om)-m0);
 deps:=deps+cos(2*(m9+d)-om)+2*cos(2*(f+d)+om-m0)+cos(4*d+2*(f-m9)+om);
 deps:=deps+cos(2*(om+d+f-m0))+cos(4*d+om)-cos(4*f+2*(om-d)+m9);
 deps:=deps-cos(3*m9+2*(f-d)+om)-2*cos(2*f+m0+m9+om)-cos(4*f+om-m9);
 deps:=deps+cos(2*(f+om)+m0+d)+cos(om-3*m9)-2*cos(2*(f+d+om)+m0-m9);
 deps:=deps-cos(2*f+d+om)+2*cos(m9-m0+2*f+om)+3*cos(om-m9-2*d);
 deps:=deps+2*cos(2*(f+d)+om-m9-m0)+cos(m9-4*d+om)+cos(4*d+om-m9);
 deps:=deps-cos(2*(m9+f-d+om)+m0)-cos(4*f-2*d+om)+cos(m9-d+2*(f+om));
 deps:=deps-cos(m0+om+2*d)-cos(2*(f+d-m9)+om)-cos(2*(om-d))+2*cos(2*(d+om));
 deps:=deps+2*cos(m0+om-2*d)+cos(2*d+om-m0)+cos(2*m9-4*d+om);
 deps:=deps-cos(4*d-2*m9+om)+cos(2*f-4*d+om)-cos(m9+m0+om+2*(f-d));
 deps:=deps-2*cos(2*(f+om)+m0-m9)-cos(om-m9-m0)+2*cos(m9+m0+om)-cos(m9-2*f+om);
 deps:=deps+cos(2*(f+om)-m9-m0)+cos(2*d+om-m9+m0)-2*cos(om-d)+2*cos(d+om);
 deps:=deps+2*cos(m0+om-m9)-3*cos(m9-m0+om)-cos(m9+2*(om-d));
 deps:=deps+2*cos(2*(d+om)-m9)-cos(2*(om+f-d)-m9)+cos(2*(f-d)+om+m0-m9);
 deps:=deps+2*cos(m9+om+2*f-4*d)+2*cos(3*m0+2*(f+om-d))+cos(2*(d-m9)+om-m0);
 deps:=deps+7*cos(2*(f-d)+om)+cos(om-2*m0)-2*cos(2*(f-d)+3*om);
 deps:=deps+cos(2*(m9+om-d))+cos(2*f-d-m9+om)-cos(2*om-m0)-cos(m9-d+om);
 deps:=deps-2*cos(2*(f+om-m9)-m0)-cos(2*(f+om)+d-3*m9)-5*cos(2*(f+om)-m9-m0-d);
 deps:=deps+3*cos(f+om-m9)-cos(f-m9+2*om)-4*cos(m0-m9+d+om);
 dpsi:=dpsi/100000;
 deps:=deps/100000;
end;

procedure ReducPole(var a0,d0,jd:Double);
var
 i,j:longint;
 eps0,eps1,pa,gpa,ppa,csa,sna,csb,snb,csc,snc,csd,snd,cse,sne,u,v:Double;
 ma:array[1..3,1..3] of Double;
 p0,p1:array[1..3] of Double;
 t,deps,dpsi:Double;
 wrk:Double;
begin
 t:=(jd-2451545)/365250;
 CalcNut(t,deps,dpsi);
 eps0:=pi*10547681.0/81000000.0;
 eps1:=eps0+pi*t*((1813*t-59)*t-468150)/648000000.0;
 ppa:=pi*((60*t-3302)*t+470029)*t/648000000.0;
 gpa:=pi*((3536*t+8698089)*t+629554982)/648000000.0;
 pa:=pi*((111113-6*t)*t+50290966)*t/648000000.0;
 eps1:=eps1+(pi*deps/648000);
 pa:=pa+gpa+(pi*dpsi/648000);
 csa:=cos(eps0);
 csb:=cos(gpa);
 csc:=cos(ppa);
 csd:=cos(pa);
 cse:=cos(eps1);
 sna:=sin(eps0);
 snb:=sin(gpa);
 snc:=sin(ppa);
 snd:=sin(pa);
 sne:=sin(eps1);
 ma[1,1]:=csd*csb+snd*csc*snb;
 ma[1,2]:=(csd*snb-snd*csc*csb)*csa+snd*snc*sna;
 ma[1,3]:=(csd*snb-snd*csc*csb)*sna-snd*snc*csa;
 ma[2,1]:=(snd*csb-csd*csc*snb)*cse-snb*snc*sne;
 ma[2,2]:=cse*(snd*snb*csa+csd*(csc*csb*csa-snc*sna))+sne*(snc*csb*csa+csc*sna);
 ma[2,3]:=cse*(snd*snb*sna+csd*(csc*csb*sna+snc*csa))+sne*(snc*csb*sna-csc*csa);
 ma[3,1]:=(snd*csb-csd*csc*snb)*sne+snb*snc*cse;
 ma[3,2]:=sne*(snd*snb*csa+csd*(csc*csb*csa-snc*sna))-cse*(snc*csb*csa+csc*sna);
 ma[3,3]:=sne*(snd*snb*sna+csd*(csc*csb*sna-snc*csa))-cse*(snc*csb*sna-csc*csa);
 p0[1]:=cos(a0)*cos(d0);
 p0[2]:=sin(a0)*cos(d0);
 p0[3]:=sin(d0);
 for i:=1 to 3 do
  begin
   p1[i]:=0.0;
   for j:=1 to 3 do p1[i]:=p1[i]+ma[i,j]*p0[j];
  end;
 if (p1[1]<>0) then a0:=arctan(p1[2]/p1[1]) else
  if (p1[2]<>0) then a0:=pi*p1[2]/abs(2*p1[2]) else a0:=0;
 if (p1[1]<0) then a0:=a0+pi;
 if (a0<0) then a0:=a0+2*pi;
 wrk:=sqrt(p1[1]*p1[1]+p1[2]*p1[2]);
 if (wrk<>0) then d0:=arctan(p1[3]/wrk) else d0:=pi*p1[3]/abs(2*p1[3]);
end;

procedure CalcLg0(t:Double;var Lg0:Double);
const
CoefLg0:array[1..52,1..3] of Double=
((963103.350030,1295977422.834286,6892.661214),
 (954202.118843,2591954845.668573,71.974609),
 (583495.455323,726695.323642,7.049246),
 (566014.969592,1186720818.548211,7.213196),
 (748260.735810,16029616014.603000,6.468250),
 (911295.139993,1621327883.002390,5.520096),
 (1265468.078844,810663941.501195,4.832139),
 (420181.326785,109256604.286075,2.626093),
 (153144.103075,2373441637.096422,2.731548),
 (421822.756827,5424417.838130,1.860209),
 (228877.502097,325350460.168104,2.473459),
 (723678.333817,82124127.045467,1.768149),
 (243150.423982,1077464214.262136,1.608424),
 (1079317.993660,1213853295.788819,2.042537),
 (522549.308506,1136014401.669299,1.553465),
 (945296.267225,388793227.876820,1.042182),
 (867357.205965,159963021.164987,1.015605),
 (602198.593486,13883.746565,0.735654),
 (391632.995487,164248254.090934,0.586050),
 (71122.458482,1131729168.743353,0.500832),
 (1206446.878478,2431991824.503586,0.654039),
 (64949.915557,2264185032.810347,0.559058),
 (991404.790721,524802520.848943,0.425236),
 (385607.545695,1149543220.124998,0.423637),
 (506932.467119,1251981326.241086,0.417193),
 (223390.210363,4285232.925947,0.260273),
 (171831.111730,43996096.593200,0.320775),
 (133133.437025,202205.735192,0.237477),
 (131184.100625,968207609.976061,0.212145),
 (880090.306834,1467274.393850,0.209821),
 (1280889.885031,442678393.803476,0.204627),
 (703606.950147,606926647.894410,0.272707),
 (140468.957300,32057758.576142,0.201329),
 (267877.636472,1294510148.440437,0.175589),
 (362013.125862,1049605041.697886,0.153979),
 (201250.966352,3242655766.004781,0.210174),
 (757157.042650,14733638591.768711,0.174729),
 (965167.823668,165387439.003117,0.151702),
 (722585.720694,650700920.336208,0.152376),
 (626422.737176,2482698241.382498,0.162446),
 (372908.887980,3560162455.644634,0.164263),
 (1234129.016093,33208775249.330998,0.176981),
 (574303.921056,1296704118.157928,0.117495),
 (375071.533889,1461364861.837403,0.126127),
 (171813.626990,1946678343.170495,0.143616),
 (904873.145855,2917305305.836677,0.115748),
 (820446.897614,182077994.368323,0.128810),
 (58387.099218,1207985229.647886,0.105494),
 (715751.272258,1295250727.510644,0.114636),
 (274915.399825,360554266.758009,0.106443),
 (39014.876376,2503962652.482173,0.107241),
 (100523.287465,246372381.136401,0.101070));
CoefDl1:array[1..11,1..3] of Double=
((552425.531745,1295977422.834286,425.026915),
 (543533.857813,2591954845.668573,8.876462),
 (328057.946643,726695.323642,0.877170),
 (611818.547105,325350460.168104,0.224781),
 (534664.852633,3887932268.502859,0.192812),
 (1195423.129299,54244178.340418,0.245993),
 (234824.557623,109256604.286075,0.148762),
 (386689.386244,82124127.045467,0.139782),
 (909459.143477,1136014401.669299,0.138872),
 (595686.651827,1077464214.262136,0.121752),
 (448567.539933,32057758.576142,0.115459));
var
Dl1,Dl2,Dl3:Double;
phs:Double;
i:Integer;
begin
Lg0:=361679.244017;
for i:=1 to 52 do
   begin
   phs:=CoefLg0[i,1]+CoefLg0[i,2]*t;
   phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
   Lg0:=Lg0+CoefLg0[i,3]*cos(phs);
   end;
Dl1:=1296027713.800282;
for i:=1 to 11 do
   begin
   phs:=CoefDl1[i,1]+CoefDl1[i,2]*t;
   phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
   Dl1:=Dl1+CoefDl1[i,3]*cos(phs);
   end;

Dl2:=109.153005;
phs:=221135.808290+1295977422.834286*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl2:=Dl2+17.985955*cos(phs);
phs:=178891.030124+259195484.566857*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl2:=Dl2+0.637616*cos(phs);

phs:=1205378.935235+1295977422.834286*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl3:=0.596571*cos(phs);

Lg0:=Lg0+t*(Dl1+t*(Dl2+t*(Dl3-0.235315*t)));
Lg0:=Lg0-1296000.0*int(Lg0/1296000.0);
if (Lg0<0) then Lg0:=Lg0+1296000.0;
Lg0:=pi*Lg0/648000.0;
end;

procedure Calcb0(t:Double;var B0:Double);
var
phs:Double;
begin
phs:=659779.557551+17395272630.982995*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
B0:=0.576758*cos(phs);
phs:=1118468.063886+1136014401.669299*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
B0:=B0+0.209654*cos(phs);
phs:=800334.684388+1077464214.262136*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
B0:=pi*(b0+0.165930*cos(phs))/648000.0;
end;

procedure CalcR0(t:Double;var r0:Double);
const
CoefR0:array[1..24,1..3] of Double=
 ((639103.975082,1295977422.834286,0.01670699626),
 (630189.744070,2591954845.668573,0.00013956023),
 (1072260.735694,16029616014.603000,0.00003083720),
 (242129.613057,1186720818.548211,0.00001628461),
 (587205.470715,1621327883.002390,0.00001575568),
 (1124745.970114,2373441637.096422,0.00000924799),
 (941411.448482,810663941.501195,0.00000542444),
 (755135.501356,1213853295.788819,0.00000472110),
 (1216928.625306,1077464214.262136,0.00000328780),
 (198774.542555,1136014401.669299,0.00000345983),
 (61605.397446,1149543220.124998,0.00000306784),
 (621256.470825,3887932268.502859,0.00000174844),
 (881471.692744,2431991824.503586,0.00000243189),
 (1206060.313677,325350460.168104,0.00000211829),
 (1035850.403455,2264185032.810347,0.00000185752),
 (1042690.534492,1131729168.743353,0.00000109835),
 (182918.334883,1251981326.241086,0.00000098316),
 (1173563.784240,3242655766.004781,0.00000086499),
 (262129.016368,33208775249.330998,0.00000085825),
 (190128.934936,10925660.446169,0.00000062916),
 (415364.293254,17325593437.437284,0.00000057056),
 (56208.425729,3560162455.644634,0.00000064903),
 (669331.854696,524802520.848943,0.00000049384),
 (1081157.193694,14733638591.768711,0.00000055736));
var
Dr1,Dr2,Dr3,phs:extended;
i:Integer;
begin
R0:=1.00013988799;
for i:=1 to 24 do
   begin
   phs:=CoefR0[i,1]+CoefR0[i,2]*t;
   phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
   R0:=R0+CoefR0[i,3]*cos(phs);
   end;

Dr1:=-0.00000702215;
phs:=228436.147541+1295977422.834286*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr1:=Dr1+0.00103018608*cos(phs);
phs:=219553.006785+2591954845.668573*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr1:=Dr1+0.00001721238*cos(phs);

phs:=1193149.360831+1295977422.834286*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr2:=0.00004359385*cos(phs);
phs:=1150822.973642+2591954845.668573*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr2:=Dr2+0.00000123633*cos(phs);

phs:=881409.604964+1295977422.834286*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr3:=0.00000144595*cos(phs);

R0:=UA*(r0+t*(Dr1+t*(Dr2+t*Dr3)));
end;

procedure Terre(t,dpsi,eps:Double;var x0,y0,z0,lg0:Double);
var
k,h,b0,r0,absol:Double;
ad0,dc0,pr0,dm0:Double;
abad,abdc,dabad,dabdc:Double;
begin
Calclg0(t,lg0);
Calcb0(t,b0);
Calcr0(t,r0);
k:=-(3740816+t*(4793106-t*(281128+t*(73831-t*(2651+t*(368-t*8))))))/1000000000.0;
h:=(16284477-t*(1532379+t*(720171-t*(32299+t*(5789-t*(166+20*t))))))/1000000000.0;
absol:=14233*pi*(1+k*cos(lg0)+h*sin(lg0))/450000000.0;
x0:=r0*cos(lg0+(dpsi*pi/648000)-absol)*cos(b0);
y0:=r0*(sin(lg0+(dpsi*pi/648000)-absol)*cos(b0)*cos(eps)-sin(b0)*sin(eps));
z0:=r0*(sin(lg0+(dpsi*pi/648000)-absol)*cos(b0)*sin(eps)+sin(b0)*cos(eps));
if (x0<>0) then ad0:=arctan(y0/x0)*12/pi else ad0:=-6*y0/abs(y0);
if (x0>0) then ad0:=ad0+12;
if (ad0<0) then ad0:=ad0+24;
dc0:=-180*arctan(z0/sqrt(x0*x0+y0*y0))/pi;
pr0:=648000*arctan(REQT/sqrt(r0*r0-REQT*REQT))/pi;
dm0:=1296000*arctan(696000/sqrt(r0*r0-484416000000.0))/pi;
abad:=14233*pi*cos(eps)*cos(lg0)/450000000.0;
abdc:=14233*pi*sin(lg0)/450000000.0;
dabad:=14233*pi*k*cos(eps)/450000000.0;
dabdc:=14233*pi*h/450000000.0;
end;

function CalcLg4(t:Double):Double;
const
CoefLg4:array[1..82,1..3] of Double=
((1044095.521287,109256604.286075,19999.226690),
 (297859.180965,1467274.393850,1183.155854),
 (1117408.091158,218513208.572150,631.973048),
 (854482.298996,130521015.385750,200.444591),
 (750892.401431,107789329.892226,150.373430),
 (703662.455280,21264411.099675,132.553986),
 (473123.498351,86524918.792550,82.105874),
 (262434.270767,65260507.692875,80.149925),
 (368089.013240,110723878.679925,57.681173),
 (1191140.130923,327769812.858225,28.030847),
 (738898.211031,42528822.199350,17.009343),
 (748741.915835,195781523.078625,18.086713),
 (1048033.802283,151785426.485426,15.197708),
 (5151.760025,43996096.593200,12.918718),
 (930913.357546,239777619.671825,12.611133),
 (272444.109625,22731685.493525,10.118153),
 (269528.773505,2934548.787699,10.942932),
 (863476.155491,217045934.178301,10.943291),
 (969358.183997,811064.830947,9.585639),
 (890395.583165,87992193.186400,6.280782),
 (323150.110969,174517111.978950,5.383514),
 (219417.379344,656209.562902,4.183444),
 (441712.117686,219980482.966000,3.640095),
 (800381.721869,261042030.771501,3.553908),
 (200425.302629,131988289.779600,3.962262),
 (738842.783764,106322055.498376,3.368752),
 (886286.231209,129053740.991901,2.953706),
 (845200.894759,19797136.705826,2.007530),
 (502670.274414,85057644.398701,1.824286),
 (1255191.709620,173049837.585101,1.511663),
 (785025.771313,326302538.464376,1.507944),
 (1265162.776626,437026417.144301,1.427204),
 (266643.823586,153252700.879275,1.462809),
 (847446.169049,305038127.364701,1.267423),
 (774663.496541,66727782.086725,1.021473),
 (936375.633033,63793233.299026,1.200259),
 (970061.578619,282306441.871176,0.774848),
 (1010111.976896,349034223.957901,0.804152),
 (1178705.445100,110067669.117022,0.703375),
 (977797.941688,9938.686072,0.681619),
 (610169.375307,93831792.346743,0.909327),
 (213596.344732,504870.355391,0.860673),
 (1076745.354432,150318152.091576,0.503637),
 (387060.985166,198675.879834,0.539465),
 (768152.258630,41061547.805501,0.529209),
 (169234.593917,78406980.407411,0.538370),
 (340574.167827,112191153.073774,0.454571),
 (372688.686863,283773716.265025,0.416647),
 (382542.147263,108445539.455128,0.427643),
 (1091660.919726,238310345.277976,0.406437),
 (252952.645957,187663582.424573,0.485013),
 (1218970.355629,197248797.472475,0.360569),
 (902914.091189,347566949.564051,0.308094),
 (665482.258452,391563046.157251,0.361343),
 (769298.741544,194314248.684776,0.361357),
 (900312.715530,370298635.057576,0.325711),
 (271852.725945,241244894.065675,0.284379),
 (515707.835465,329237087.252075,0.242351),
 (805799.253371,15424811.939332,0.310433),
 (699074.581116,107518.595723,0.240829),
 (939412.017404,108600394.723173,0.218424),
 (859851.860069,215578659.784451,0.269240),
 (646781.165794,101391101.078631,0.291751),
 (293138.170981,109912813.848978,0.205256),
 (243716.038983,24198959.908372,0.198297),
 (176885.753852,262509305.165350,0.189264),
 (251102.940277,93525597.871186,0.180884),
 (485223.434577,602450.265041,0.141306),
 (1102250.555811,303570852.970851,0.136337),
 (913085.489071,8117938.385140,0.159651),
 (874222.284159,435559142.750451,0.148523),
 (1026508.830968,154855.268045,0.130784),
 (848377.432705,412827457.256926,0.122577),
 (105631.062009,45463370.987050,0.128876),
 (616451.989249,456823553.850126,0.137232),
 (851106.715113,864824.128809,0.124097),
 (238221.871829,4401823.181549,0.115533),
 (188128.386423,2123483.956752,0.109019),
 (1060573.526113,172238772.754153,0.144998),
 (845785.084038,259574756.377651,0.107084),
 (1210045.019772,1186720818.548211,0.120025),
 (323985.708835,202782202.157261,0.112330));
CoefDl1:array[1..50,1..3] of Double=
((870575.040214,109256604.286075,1010.163725),
 (1243049.624006,1467274.393850,472.178379),
 (943178.739877,218513208.572150,57.043316),
 (1126079.889176,107789329.892226,42.740013),
 (35035.655351,110723878.679925,24.969865),
 (912555.728610,21264411.099675,12.516254),
 (821920.663734,86524918.792550,11.208273),
 (1214918.997176,2934548.787699,8.741080),
 (1086544.103732,42528822.199350,4.562276),
 (1145043.522321,656209.562902,2.672715),
 (1016203.538973,327769812.858225,3.601216),
 (106125.089561,811064.830947,2.399707),
 (95868.578718,151785426.485426,2.077532),
 (1207984.277609,217045934.178301,2.419752),
 (1187684.821790,22731685.493525,1.748461),
 (990714.648635,43996096.593200,1.706489),
 (649817.268153,87992193.186400,2.070020),
 (1094657.602029,106322055.498376,2.266304),
 (120959.983538,219980482.966000,1.683919),
 (1138225.864852,131988289.779600,1.496342),
 (1235251.959228,129053740.991901,1.171264),
 (852379.553775,85057644.398701,0.978069),
 (1183244.024690,19797136.705826,0.851729),
 (769880.809039,239777619.671825,0.692672),
 (874891.905771,130521015.385750,0.712127),
 (1287715.778188,63793233.299026,0.482796),
 (457658.311959,66727782.086725,0.401771),
 (832216.552571,195781523.078625,0.483361),
 (1295267.879786,112191153.073774,0.379399),
 (310342.815575,173049837.585101,0.409487),
 (1255370.031050,153252700.879275,0.385507),
 (1117245.665604,41061547.805501,0.353497),
 (129211.240920,150318152.091576,0.269735),
 (926712.214657,197248797.472475,0.221889),
 (140299.362053,174517111.978950,0.238015),
 (1090401.776481,437026417.144301,0.237301),
 (1182650.467332,4401823.181549,0.137834),
 (1231944.298501,109912813.848978,0.143597),
 (1255747.339668,326302538.464376,0.133763),
 (1201311.808982,215578659.784451,0.164364),
 (2051367.228470,329237087.252075,0.119508),
 (26658.058412,108600394.723173,0.135382),
 (120926.808199,238310345.277976,0.120683),
 (291242.686299,110067669.117022,0.116746),
 (1101789.555729,194314248.684776,0.147774),
 (1231094.187427,241244894.065675,0.118330),
 (1119618.535683,2123483.956752,0.113312),
 (47402.332121,282306441.871176,0.107291),
 (1181199.026969,24198959.887374,0.107895),
 (1254245.025469,108445539.455128,0.103995));
CoefDl2:array[1..27,1..3] of Double=
((891369.902279,1467274.393850,97.426289),
 (604400.105924,109256604.286075,63.176957),
 (217618.890939,107789329.892226,6.578439),
 (704211.823925,218513208.572150,5.617329),
 (999446.798288,110723878.679925,5.629569),
 (863701.668236,2934548.787699,3.549960),
 (1189716.249482,86524918.792550,0.790526),
 (1248952.214020,21264411.099675,0.758019),
 (156862.250046,106322055.498376,0.778699),
 (781010.105526,656209.562902,0.695909),
 (143058.368100,42528822.199350,0.635708),
 (786671.676592,327769812.858225,0.450499),
 (1101446.729436,219980482.966000,0.410226),
 (512271.851497,811064.830947,0.407260),
 (786638.685536,131988289.779600,0.301621),
 (290095.828453,217045934.178301,0.321488),
 (1204047.854403,85057644.398701,0.267257),
 (337109.234710,87992193.186400,0.292756),
 (291731.582872,129053740.991901,0.242004),
 (832038.045964,22731685.493525,0.199526),
 (228192.052643,19797136.705826,0.187336),
 (956503.806303,112191153.073774,0.162473),
 (457323.459847,151785426.485426,0.149319),
 (520272.394640,130521015.385750,0.180053),
 (644148.612183,43996096.593200,0.117385),
 (345047.588664,63793233.299026,0.100290),
 (171645.975942,41061547.805501,0.120613));
CoefDl3:array[1..7,1..3] of Double=
((536005.666934,1467274.393850,13.410647),
 (277706.450245,109256604.286075,2.798032),
 (510513.600434,2934548.787699,0.970921),
 (66922.872597,110723899.306405,0.860042),
 (613349.355824,107789329.892226,0.727807),
 (428134.753421,218513208.572150,0.319463),
 (518614.870233,106322055.498376,+0.178978));
var
Dl1,Dl2,Dl3,Dl4,Dl5,phs,Lg4:Double;
i:Integer;
begin
Lg4:=123665.428248;
for i:=1 to 82 do
   begin
   phs:=CoefLg4[i,1]+CoefLg4[i,2]*t;
   phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
   Lg4:=Lg4+CoefLg4[i,3]*cos(phs);
   end;
Dl1:=109306900.408043;
for i:=1 to 50 do
   begin
   phs:=CoefDl1[i,1]+CoefDl1[i,2]*t;
   phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
   Dl1:=Dl1+CoefDl1[i,3]*cos(phs);
   end;
Dl2:=80.372216;
for i:=1 to 27 do
   begin
   phs:=CoefDl2[i,1]+CoefDl2[i,2]*t;
   phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
   Dl2:=Dl2+CoefDl2[i,3]*cos(phs);
   end;
Dl3:=0;
for i:=1 to 7 do
   begin
   phs:=CoefDl3[i,1]+CoefDl3[i,2]*t;
   phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
   Dl3:=Dl3+CoefDl3[i,3]*cos(phs);
   end;

Dl4:=-0.235181;
phs:=175907.620624+1467274.393850*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl4:=Dl4+1.380908*cos(phs);
phs:=153170.074700+2934548.787699*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl4:=Dl4+0.206184*cos(phs);
phs:=341051.036080+110723878.679925*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl4:=Dl4+0.103182*cos(phs);

phs:=1084249.448120+1467274.393850*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl5:=0.102260*cos(phs);

Lg4:=lg4+t*(dl1+t*(dl2+t*(dl3+t*(dl4+t*dl5))));
Lg4:=Lg4-1296000.0*int(Lg4/1296000.0);
if (Lg4<0) then Lg4:=Lg4+1296000.0;
Lg4:=pi*Lg4/648000.0;
Result:=Lg4;
end;

function CalcB4(t:Double):Double;
const
CoefB4:array[1..33,1..3] of Double=
((733998.689772,109256604.286075,4679.355784),
 (806102.143187,218513208.572150,226.832778),
 (743604.373010,107789329.892226,16.710393),
 (878446.969193,327769812.858225,12.466637),
 (63172.972633,110723878.679925,13.278879),
 (615771.446971,239777619.671825,2.283104),
 (605632.810801,217045934.178301,1.942295),
 (361886.301392,1467274.393850,1.844189),
 (444446.191302,130521015.385750,1.582629),
 (345539.523581,87992193.186400,1.947816),
 (758660.047002,43996096.593200,1.411305),
 (132717.546627,219980482.966000,1.297866),
 (1068208.248680,21264411.099675,1.781841),
 (557546.053019,22731685.493525,1.096648),
 (2794.538522,174517111.978950,1.152038),
 (242025.449687,195781523.078625,0.957995),
 (537990.181913,86524918.792550,0.889150),
 (951010.684473,437026417.144301,0.724883),
 (690921.470321,349034223.957901,0.254011),
 (1041415.114950,65260507.692875,0.237283),
 (985568.290021,153252700.879275,0.272600),
 (478284.769180,305038127.364701,0.213282),
 (286065.013090,66727782.086725,0.240049),
 (650340.115639,326302538.464376,0.211256),
 (763393.964591,106322055.498376,0.214024),
 (821591.198347,261042030.771501,0.162227),
 (528050.726287,197248797.472475,0.144251),
 (77350.855552,283773716.265025,0.114677),
 (204216.842244,329237087.252075,0.107229),
 (82869.798441,108445539.455128,0.113846),
 (928343.386067,151785426.485426,0.130887),
 (38468.165837,112191153.073774,0.102495),
 (736902.782639,110067669.117022,0.100721));
CoefDb1:array[1..16,1..3] of Double=
((1176052.802762,109256604.286075,365.814320),
 (1192090.161353,218513208.572150,6.662706),
 (1129226.170503,107789329.892226,6.355769),
 (976617.407177,110723878.679925,4.562400),
 (978922.816334,217045934.178301,7.145951),
 (1070217.529220,219980482.966000,0.483204),
 (1275859.800875,1467274.393850,0.404597),
 (810045.676080,327769812.858225,0.310363),
 (709339.041429,130521015.385750,0.235406),
 (601109.901484,195781523.078625,0.199390),
 (516739.107050,21264411.099675,0.157997),
 (1047136.492384,239777619.671825,0.168459),
 (126417.598828,86524918.792550,0.157941),
 (1134370.405753,106322055.498376,0.152378),
 (814332.664187,151785426.485426,0.102957),
 (1123607.079553,43996096.593200,0.124881));
var
Db1,Db2,Db3,phs,B4:Double;
i:Integer;
begin
B4:=227.077664;
for i:=1 to 33 do
   begin
   phs:=CoefB4[i,1]+CoefB4[i,2]*t;
   phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
   B4:=B4+CoefB4[i,3]*cos(phs);
   end;
Db1:=-3.494604;
for i:=1 to 16 do
   begin
   phs:=CoefDb1[i,1]+CoefDb1[i,2]*t;
   phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
   Db1:=Db1+CoefDb1[i,3]*cos(phs);
   end;

Db2:=-1.677436;
phs:=301812.529966+109256604.286075*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Db2:=Db2+16.695179*cos(phs);
phs:=197378.173784+107789329.892226*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Db2:=Db2+1.531341*cos(phs);
phs:=597938.296179+110723878.679925*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Db2:=Db2+0.822896*cos(phs);
phs:=298431.738551+218513208.572150*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Db2:=db2+0.705892*cos(phs);
phs:=84000.673770+217045934.178301*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Db2:=Db2+0.152529*cos(phs);

phs:=697356.399494+109256604.286075*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Db3:=0.519012*cos(phs);
phs:=563746.131451+107789329.892226*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Db3:=Db3+0.251103*cos(phs);
phs:=213875.970760+110723878.679925*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Db3:=Db3+0.100439*cos(phs);

B4:=pi*(B4+t*(Db1+t*(Db2+t*Db3)))/648000.0;
Result:=B4;
end;

function CalcR4(t:Double):Double;
const
CoefR4:array[1..61,1..3] of Double=
((720088.259919,109256604.286075,0.25209327020),
 (792294.814624,218513208.572150,0.00610599902),
 (530966.616585,130521015.385750,0.00282029465),
 (428185.895264,107789329.892226,0.00187647391),
 (146450.261978,86524918.792550,0.00086792941),
 (44276.173675,110723878.679925,0.00072062869),
 (1233454.983107,65260507.692875,0.00065517227),
 (346028.279000,21264411.099675,0.00029134620),
 (445804.371598,195781523.078625,0.00030135275),
 (730225.158854,151785426.485426,0.00023453209),
 (864997.812327,327769812.858225,0.00022283710),
 (56635.891197,1467274.393850,0.00023947340),
 (610632.635332,239777619.671825,0.00013032600),
 (393284.224087,42528822.199350,0.00009703346),
 (560112.293532,217045934.178301,0.00012749004),
 (910355.124313,43996096.593200,0.00009161431),
 (511346.030575,87992193.186400,0.00007894539),
 (450038.358265,261042030.771501,0.00007057978),
 (1292078.930364,174517111.978950,0.00006137755),
 (1166900.496443,131988289.779600,0.00005477093),
 (116604.171039,219980482.966000,0.00003502519),
 (561494.013661,129053740.991901,0.00004136890),
 (415840.232583,106322055.498376,0.00004170012),
 (938880.385758,173049837.585101,0.00002499966),
 (414579.816867,326302538.464376,0.00002616955),
 (176607.902696,85057644.398701,0.00001911876),
 (1263890.615355,153252700.879275,0.00002127644),
 (637085.547108,282306441.871176,0.00001610549),
 (552843.704325,305038127.364701,0.00001479484),
 (389929.135804,66727782.086725,0.00001230708),
 (371630.521259,22731685.493525,0.00001216810),
 (938251.141684,437026417.144301,0.00000961072),
 (855557.432954,110067669.117022,0.00000885708),
 (758429.411168,150318152.091576,0.00000776700),
 (592410.963842,63793233.299026,0.00000998579),
 (286034.084988,93831792.346743,0.00001014959),
 (822634.966673,238310345.277976,0.00000727162),
 (575614.127845,347566949.564051,0.00000655289),
 (328667.569841,391563046.157251,0.00000821465),
 (994782.857320,197248797.472475,0.00000620798),
 (697486.041432,349034223.957901,0.00000653981),
 (1225402.504693,187663584.693486,0.00000812036),
 (16699.172396,112191153.073774,0.00000562120),
 (58497.248512,108445539.455128,0.00000542221),
 (26242.441180,283773716.265025,0.00000457859),
 (469510.091141,194314248.684776,0.00000614784),
 (536849.804140,19797136.705826,0.00000435805),
 (1140656.646684,78406980.407411,0.00000496066),
 (581452.807718,370298635.057576,0.00000469965),
 (30163.272188,2934548.787699,0.00000445003),
 (803069.630116,303570852.970851,0.00000290869),
 (520279.151590,412827457.256926,0.00000276627),
 (616450.258252,108600394.723173,0.00000275084),
 (422715.873842,41061547.805501,0.00000293875),
 (1244047.455191,241244894.065675,0.00000290985),
 (577279.898419,215578659.784451,0.00000338342),
 (1265218.994850,109912813.848978,0.00000257482),
 (278051.416566,456823553.850126,0.00000319013),
 (1107344.585896,262509305.165350,0.00000309352),
 (322607.013338,101391101.078631,0.00000345804),
 (238044.962155,1186720818.548211,0.00000303364));
CoefDr1:array[1..30,1..3] of Double=
((546472.843992,109256604.286075,0.01271801596),
 (618951.697756,218513208.572150,0.00061661771),
 (803850.343774,107789329.892226,0.00053443592),
 (1007142.913972,110723878.679925,0.00031185167),
 (497778.007468,86524918.792550,0.00011847190),
 (981778.004898,1467274.393850,0.00009166360),
 (576093.451884,21264411.099675,0.00003175763),
 (1074811.429173,151785426.485426,0.00003203446),
 (690344.664431,327769812.858225,0.00003403605),
 (749638.708195,42528822.199350,0.00002600003),
 (303100.580759,87992193.186400,0.00002412207),
 (771891.776494,106322055.498376,0.00002806064),
 (893235.681196,217045934.178301,0.00002676575),
 (810131.185669,131988289.779600,0.00002100507),
 (1095170.230617,219980482.966000,0.00001646182),
 (910924.520144,129053740.991901,0.00001641257),
 (652031.151909,43996096.593200,0.00001049866),
 (526867.646213,85057644.398701,0.00001024802),
 (447789.819093,239777619.671825,0.00000740996),
 (552275.671692,130521015.385750,0.00000806404),
 (1289059.084223,173049837.585101,0.00000676928),
 (971452.501924,112191153.073774,0.00000468895),
 (83085.900773,66727782.086725,0.00000444683),
 (943982.054435,153252700.879275,0.00000567076),
 (1107303.772836,150318152.091576,0.00000415894),
 (509232.315023,195781523.078625,0.00000484689),
 (653409.677703,197248797.472475,0.00000337555),
 (949908.922717,63793233.299026,0.00000401738),
 (965626.233259,2934548.787699,0.00000347378),
 (1102052.864676,174517111.978950,0.00000260753));
CoefDr2:array[1..16,1..3] of Double=
((280243.528370,109256604.286075,0.00079644833),
 (1191744.288490,107789329.892226,0.00008251618),
 (675469.729079,110723878.679925,0.00007029864),
 (379187.132862,218513208.572150,0.00005314006),
 (614013.487998,1467274.393850,0.00001860833),
 (866085.050977,86524918.786362,0.00000836267),
 (1130396.775852,106322055.498376,0.00000964466),
 (780198.136093,219980482.966000,0.00000406453),
 (459461.253827,131988289.779600,0.00000426570),
 (462545.430566,327769812.858225,0.00000377316),
 (1263765.623602,129053740.991901,0.00000339043),
 (1107150.784274,42528822.199350,0.00000362943),
 (1258056.430933,217045934.178301,0.00000342048),
 (879023.370074,85057644.398701,0.00000279920),
 (678.531101,87992193.186400,0.00000332578),
 (198625.510655,130521015.385750,0.00000257290));

var
Dr1,Dr2,Dr3,phs,R4:Double;
i:Integer;
begin
R4:=5.20887429471;
for i:=1 to 61 do
   begin
   phs:=CoefR4[i,1]+CoefR4[i,2]*t;
   phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
   R4:=R4+CoefR4[i,3]*cos(phs);
   end;
Dr1:=0.00041390257;
for i:=1 to 30 do
   begin
   phs:=CoefDr1[i,1]+CoefDr1[i,2]*t;
   phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
   Dr1:=Dr1+CoefDr1[i,3]*cos(phs);
   end;
Dr2:=-0.00000497920;
for i:=1 to 16 do
   begin
   phs:=CoefDr2[i,1]+CoefDr2[i,2]*t;
   phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
   Dr2:=Dr2+CoefDr2[i,3]*cos(phs);
   end;

phs:=1249553.503646+109256604.286075*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr3:=0.00003519257*cos(phs);
phs:=345125.049642+110723878.679925*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr3:=Dr3+0.00001073239*cos(phs);
phs:=291513.382610+107789329.892226*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr3:=Dr3+0.00000915666*cos(phs);
phs:=107869.362383+218513208.572150*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr3:=Dr3+0.00000341593*cos(phs);
phs:=246745.251205+1467274.393850*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr3:=Dr3+0.00000254893*cos(phs);
R4:=UA*(R4+t*(Dr1+t*(Dr2+t*Dr3)));
Result:=R4;
end;

procedure Jupiter(jd:double;var d4,ad4,dc4,x0,y0,z0,x4,y4,z4,eps,lg4,b4,lg0,r4:Double);
var
xa,ya,za,xb,yb,zb,xc,yc,zc,xd,yd,zd:Double;
lp:longint;
t:Double;
deps,dpsi:double;
dt,cfi,cfe,cfs,pr4,dm4:Double;
begin
t:=(jd-2451546)/365250;
CalcNut(t,deps,dpsi);
eps:=pi*(deps+84381.448+t*((1.813*t-0.059)*t-468.15))/648000;
Terre(t,dpsi,eps,x0,y0,z0,lg0);
lg4:=Calclg4(t);
b4:=Calcb4(t);
r4:=Calcr4(t);
x4:=r4*cos(lg4+(dpsi*pi/648000))*cos(b4);
y4:=r4*(sin(lg4+(dpsi*pi/648000))*cos(b4)*cos(eps)-sin(b4)*sin(eps));
z4:=r4*(sin(lg4+(dpsi*pi/648000))*cos(b4)*sin(eps)+sin(b4)*cos(eps));
xa:=x4-x0;
ya:=y4-y0;
za:=z4-z0;
t:=(jd-2451544)/365250;
CalcNut(t,deps,dpsi);
eps:=pi*(deps+84381.448+t*((1.813*t-0.059)*t-468.15))/648000;
Terre(t,dpsi,eps,x0,y0,z0,lg0);
lg4:=Calclg4(t);
b4:=Calcb4(t);
r4:=Calcr4(t);
x4:=r4*cos(lg4+(dpsi*pi/648000))*cos(b4);
y4:=r4*(sin(lg4+(dpsi*pi/648000))*cos(b4)*cos(eps)-sin(b4)*sin(eps));
z4:=r4*(sin(lg4+(dpsi*pi/648000))*cos(b4)*sin(eps)+sin(b4)*cos(eps));
xc:=x4-x0;
yc:=y4-y0;
zc:=z4-z0;
t:=(jd-2451545)/365250;
CalcNut(t,deps,dpsi);
eps:=pi*(deps+84381.448+t*((1.813*t-0.059)*t-468.15))/648000;
Terre(t,dpsi,eps,x0,y0,z0,lg0);
lg4:=Calclg4(t);
b4:=Calcb4(t);
r4:=Calcr4(t);
x4:=r4*cos(lg4+(dpsi*pi/648000))*cos(b4);
y4:=r4*(sin(lg4+(dpsi*pi/648000))*cos(b4)*cos(eps)-sin(b4)*sin(eps));
z4:=r4*(sin(lg4+(dpsi*pi/648000))*cos(b4)*sin(eps)+sin(b4)*cos(eps));
xb:=x4-x0;
yb:=y4-y0;
zb:=z4-z0;
xd:=xb;
yd:=yb;
zd:=zb;
for lp:=1 to MAXITER do
   begin
   dt:=sqrt(xd*xd+yd*yd+zd*zd)/JLM;
   cfi:=dt*(dt+1)/2;
   cfe:=1-dt*dt;
   cfs:=dt*(dt-1)/2;
   xd:=cfi*xa+cfe*xb+cfs*xc-x0;
   yd:=cfi*ya+cfe*yb+cfs*yc-y0;
   zd:=cfi*za+cfe*zb+cfs*zc-y0;
   end;
dt:=sqrt(xd*xd+yd*yd+zd*zd)/JLM;
cfi:=dt*(dt+1)/2;
cfe:=1-dt*dt;
cfs:=dt*(dt-1)/2;
x4:=cfi*xa+cfe*xb+cfs*xc;
y4:=cfi*ya+cfe*yb+cfs*yc;
z4:=cfi*za+cfe*zb+cfs*zc;
if (x4<>0) then ad4:=arctan(y4/x4)*12/pi else ad4:=6*y4/abs(y4);
if (x4<0) then ad4:=ad4+12;
if (ad4<0) then ad4:=ad4+24;
dc4:=arctan(z4/sqrt(x4*x4+y4*y4))*180/pi;
d4:=sqrt(x4*x4+y4*y4+z4*z4);
pr4:=648000*arctan(REQT/sqrt(d4*d4-REQT*REQT))/pi;
dm4:=1296000*arctan(71492/sqrt(d4*d4-5111106064.0))/pi;
end;

//    w1  w2  Phase Lat Dequ DPol
//    lc1 lc2 aph   bc  dae  dap
procedure JupPhys(qu:TDateTime;var ad,dc,aph,lc1,lc2,bc,dae,dap,th0,ap,Apl:double);
var
fev,l1,l2,l3,w1,w2,w3,delta,fil,ls1,ls2,ls3,bs,dlg:Double;
d,g,h,l,mrg,s,lgs,nd,inc,lc3,x,y,z,u,v,w,n,b,imj:Double;
th,psi,at,aas,ds,elg,p,q,lgp,dclv,dclh,acd,bcd,ccd,crd,dbd:Double;
fel,a0,d0,ai,di,xs,ys,zs,us,vs,ws,ecl:Double;
iis:longint;
rep:Char;
jd:Double;  // Jour Julien
t:Double;
d4,x0,y0,z0,x4,y4,z4,eps,lg4,b4,lg0,r4:Double;
wrk:Double;
cor:longint;
begin
apl:=33427/35746;
//write('Date et TE (jj mm aaaa hh mm ss.ssss) : ');
//readln(ms,an,hr,mn,sc);
jd:=jj(qu);
t:=(jd-2451545.0)/36525.0;
a0:=pi*(268050-9*t)/180000;
d0:=pi*(64490+3*t)/180000;
ReducPole(a0,d0,jd);
Jupiter(jd,d4,ad,dc,x0,y0,z0,x4,y4,z4,eps,lg4,b4,lg0,r4);
w1:=67.10+877.900*(jd-2451545-(d4/JLM));
w2:=43.30+870.270*(jd-2451545-(d4/JLM));
w3:=284.95+870.536*(jd-2451545-(d4/JLM));
ai:=pi*ad/12;
di:=pi*dc/180;
x:=x0+x4;
y:=y0+y4;
z:=z0+z4;
if (x<>0) then aas:=arctan(y/x) else aas:=-pi*y/abs(2*y);
if (x>0) then aas:=aas+pi;
if (aas<0) then aas:=aas+2*pi;
ds:=-arctan(z/sqrt(x*x+y*y));
x:=cos(ai-a0)*sin(d0)*cos(di)-sin(di)*cos(d0);
y:=sin(ai-a0)*cos(di);
z:=-(cos(ai-a0)*cos(d0)*cos(di)+sin(di)*sin(d0));
u:=sin(d0)*cos(di)-cos(ai-a0)*sin(di)*cos(d0);
v:=sin(a0-ai)*cos(d0);
xs:=sin(ds)*cos(d0)-cos(a0-aas)*sin(d0)*cos(ds);
ys:=sin(a0-aas)*cos(ds);
zs:=cos(a0-aas)*cos(d0)*cos(ds)+sin(ds)*sin(d0);
us:=sin(ds)*cos(di)-cos(ds)*sin(di)*cos(aas-ai);
vs:=sin(aas-ai)*cos(ds);
ws:=-(cos(ds)*cos(di)*cos(aas-ai)+sin(ds)*sin(di));
if (x<>0) then at:=arctan(y/x)*180/pi else at:=90*y/abs(y);
if (x<0) then at:=at+180;
lc1:=w1-at-90;
lc1:=lc1-360*int(lc1/360);
if (lc1<0) then lc1:=lc1+360;
lc2:=w2-at-90;
lc2:=lc2-360*int(lc2/360);
if (lc2<0) then lc2:=lc2+360;
lc3:=w3-at-90;
lc3:=lc3-360*int(lc3/360);
if (lc3<0) then lc3:=lc3+360;
wrk:=sqrt(x*x+y*y);
if (wrk<>0) then bc:=arctan(z/wrk)*180/pi else bc:=90*z/abs(z);
if (u<>0) then ap:=arctan(v/u)*180/pi else if (v=0) then ap:=0 else ap:=90*v/abs(v);
if (u<0) then ap:=ap+180;
if (ap<0) then ap:=ap+360;
if (xs<>0) then at:=arctan(ys/xs)*180/pi else at:=90*ys/abs(ys);
if (xs<0) then at:=at+180;
ls1:=w1-at-90;
ls1:=ls1-360*int(ls1/360);
if (ls1<0) then ls1:=ls1+360;
ls2:=w2-at-90;
ls2:=ls2-360*int(ls2/360);
if (ls2<0) then ls2:=ls2+360;
ls3:=w3-at-90;
ls3:=ls3-360*int(ls3/360);
if (ls3<0) then ls3:=ls3+360;
wrk:=sqrt(xs*xs+ys*ys);
if (wrk<>0) then bs:=arctan(zs/wrk)*180/pi else bs:=90*zs/abs(zs);
if (us<>0) then th0:=arctan(vs/us)*180/pi else if (vs=0) then th0:=0 else th0:=90*vs/abs(vs);
if (us<0) then th0:=th0+180;
th0:=th0-180;
if (th0<0) then th0:=th0+360;
fil:=(1+ws)/2;
dae:=arctan(71492/sqrt(d4*d4-5111106064.0))*1296000/pi;
wrk:=bc*pi/180;
dap:=71492*sqrt(sin(wrk)*sin(wrk)+apl*apl*cos(wrk)*cos(wrk));
dap:=arctan(dap/sqrt(d4*d4-dap*dap))*1296000/pi;
x:=y4*z0-y0*z4;
u:=x0*z4-x4*z0;
v:=x4*y0-x0*y4;
y:=u*cos(eps)+v*sin(eps);
z:=v*cos(eps)-u*sin(eps);
u:=z*sqrt(x*x+y*y+z*z)/abs(z);
v:=x4*(x4+x0)+y4*(y4+y0)+z4*(z4+z0);
if (v<>0) then aph:=180*arctan(u/v)/pi else aph:=90*u/abs(u);
if (v<0) then aph:=aph+180;
if (aph>180) then aph:=aph-360;
v:=x4*(x4+x0)+y4*(y4+y0)*cos(eps)*cos(eps)+z4*(z4+z0)*sin(eps)*sin(eps)+(z4*(y4+y0)+y4*(z4+z0))*cos(eps)*sin(eps);
w:=-(x0*x4+y0*y4+z0*z4);
if (w<>0) then elg:=180*arctan(u/w)/pi else elg:=90*u/abs(u);
if (w<0) then elg:=elg+180;
if (elg>180) then elg:=elg-360;
if (v<>0) then dlg:=180*arctan(z/v)/pi else dlg:=90*z/abs(z);
if (v<0) then dlg:=dlg+180;
if (dlg>180) then dlg:=dlg-360;
w:=-(x4*x0+y4*y0*cos(eps)*cos(eps)+z4*z0*sin(eps)*sin(eps)+(z4*y0+y4*z0)*cos(eps)*sin(eps));
if (w<>0) then ecl:=180*arctan(z/w)/pi else ecl:=90*z/abs(z);
if (w<0) then ecl:=ecl+180;
if (ecl>180) then ecl:=ecl-360;
q:=(-2065611-t*(1905724-t*(108273+t*(8934-t*(422+12*t)))))/1000000000.0;
p:=(11183772-t*(839731+t*(159489-t*(7916+t*(378-20*t)))))/1000000000.0;
xs:=cos(a0)*cos(d0);
ys:=sin(a0)*cos(d0)*cos(eps)+sin(d0)*sin(eps);
zs:=sin(d0)*cos(eps)-sin(a0)*cos(d0)*sin(eps);
us:=2*p*sqrt(1-p*p-q*q);
vs:=-2*q*sqrt(1-p*p-q*q);
ws:=1-2*p*p-2*q*q;
x:=zs*vs-ys*ws;
y:=xs*ws-zs*us;
z:=ys*us-xs*vs;
wrk:=sqrt(x*x+y*y+z*z);
x:=x/wrk;
y:=y/wrk;
z:=z/wrk;
u:=z*vs-y*ws;
v:=x*ws-z*us;
w:=y*us-x*vs;
p:=(x*cos(lg4)+y*sin(lg4))*cos(b4)+z*sin(b4);
q:=(u*cos(lg4)+v*sin(lg4))*cos(b4)+w*sin(b4);
if (p<>0) then lgp:=arctan(q/p)*180/pi else lgp:=90*q/abs(q);
if (p<0) then lgp:=lgp+180;
if (lgp<0) then lgp:=lgp+360;
iis:=trunc(lgp/90) mod 4;
cor:=trunc(jd+1.5) mod 7;
// Jour julien                                         jd
// Angle de phase (i)                                  aph
// Angle de position du milieu de la phase             th0
// Fraction illuminee du disque                        fil
// Longit. jovicentriques de la Terre (L0I, II, III)   lc1 lc2 lc3
// Latitude jovicentrique de la Terre                  bc
// Angle de position du pele (P)                       ap
// Longitudes jovicentriques du Soleil                 ls1 ls2 ls3
// Latitude jovicentrique du Soleil                    bs
// DiamŠtre apparent equatorial (secondes d''arc)      dae
// DiamŠtre apparent polaire (secondes d''arc)         dap
// Longitude ecliptique heliocentrique (lambda)        lg4*180/pi
// Latitude ecliptique heliocentrique (beta)           b4*180/pi
// Longitude ecliptique de la Terre                    lg0*180/pi
// Longitude saisonniere de Jupiter                    lgp
// Distance au Soleil (r en UA)                        r4/UA
// Distance a la Terre (delta, en UA)                  d4/UA
// Elongation                                          elg
// Angle de phase ecliptique                           dlg
// Elongation ecliptique                               ecl
end;

function CalcLg3(t:Double):Double;
const
CoefLg3:array[1..94,1..3] of Double=
 ((1041713.796416,689050774.939877,38481.521514),
 (1114035.882242,1378101549.879795,2285.861219),
 (1187010.118596,2067152324.819630,189.347780),
 (1231503.021069,726695.323642,57.228144),
 (606332.981982,470537566.367726,21.885170),
 (175234.496361,579794170.653801,25.403361),
 (857438.356499,3558.821228,18.412789),
 (1260288.609005,2756203099.759506,17.977397),
 (75208.776169,82124127.045467,14.020957),
 (688859.799314,1159588341.307603,16.036814),
 (342784.345031,524802520.848943,7.374130),
 (47059.264660,606926647.894410,8.582887),
 (176761.919932,39489039.515852,6.343158),
 (133672.266471,688324079.616235,5.420891),
 (1253870.786024,13883.746565,6.059117),
 (1039360.935929,164248254.090934,4.928533),
 (6181.150231,689777470.263519,5.321306),
 (237161.843215,1268844945.593678,3.152015),
 (135379.898302,109256604.286075,3.710308),
 (747246.017072,1050331737.021528,2.607921),
 (632812.019504,442678393.803476,2.653044),
 (601426.165872,361280962.081651,3.189695),
 (761806.665005,1848639116.247480,2.114022),
 (37733.875513,3445253874.699383,1.839051),
 (495228.813788,601058581.753477,1.771320),
 (508274.829865,689047216.118649,1.717604),
 (514621.932465,689054333.761105,1.717617),
 (755622.271116,218513208.572150,1.470460),
 (788443.920545,32057758.576142,1.544354),
 (139223.723321,771174901.985344,1.493075),
 (602670.088860,1739382511.961404,1.310930),
 (100789.389986,645054678.346677,1.351371),
 (785871.398134,202205.735192,1.135430),
 (922991.409797,360554266.758009,1.140120),
 (114198.794979,1295977422.834286,0.878630),
 (102435.877346,43996096.593200,0.856271),
 (747808.557259,246372381.136401,0.973908),
 (78489.664083,1378828245.203395,0.632309),
 (205962.262893,1377374854.556111,0.643837),
 (870708.262498,4285232.925947,0.604766),
 (925341.358549,728539814.455728,0.623697),
 (111841.195811,689036891.193311,0.565223),
 (1213174.041621,278430139.712542,0.579755),
 (264515.401052,798307379.225952,0.476853),
 (1189911.746720,649561735.424025,0.584967),
 (1187063.273996,687583500.546027,0.487020),
 (27582.763713,689064658.686442,0.565238),
 (574083.852296,1290109356.693353,0.617549),
 (581941.634855,252024357.795576,0.421112),
 (1107962.692890,853299029.030810,0.492678),
 (307547.048063,1957895720.533555,0.389096),
 (722889.402380,78978079.031703,0.456309),
 (207422.184011,196306012.667075,0.369618),
 (90639.029861,1131729168.743353,0.355002),
 (692462.178412,740579.070208,0.398351),
 (292636.530168,27859172.564250,0.297650),
 (814446.354501,941075132.735453,0.330046),
 (497841.422345,114181885.621608,0.359041),
 (834324.063088,2537689891.187356,0.270192),
 (887238.115745,1467274.393850,0.285151),
 (372649.639174,1049605041.697886,0.264147),
 (686021.309058,557062485.160277,0.288558),
 (455446.410882,328496508.181868,0.264229),
 (216980.427298,1630125907.675329,0.241216),
 (216980.427298,50066368.469325,0.227665),
 (763325.814725,327769812.858225,0.234082),
 (669006.988662,2428433286.901281,0.206450),
 (111288.487209,4134304649.639260,0.197173),
 (999473.227800,1378105108.700981,0.204093),
 (161990.853674,1820779943.683229,0.215631),
 (822936.184096,907563983.512027,0.173648),
 (454167.753722,2319176682.615206,0.179308),
 (578175.824936,656993016.363735,0.147349),
 (1205972.779454,1213853295.788819,0.148698),
 (450540.116911,1738655816.637762,0.151555),
 (580596.528808,1378097991.058525,0.204091),
 (564825.055649,472004840.761576,0.141114),
 (210580.323000,1460225676.925220,0.178937),
 (553034.305807,5868066.140933,0.134732),
 (660575.688081,967480914.652419,0.172745),
 (158088.398159,1334105453.286553,0.154769),
 (776380.177487,1246113260.100153,0.142290),
 (151874.057262,768028853.971580,0.137591),
 (933908.196307,87992193.186400,0.130594),
 (1272306.317774,469070291.973877,0.127230),
 (1855178.321801,1985028197.774163,0.107786),
 (950108.227074,885356787.606952,0.114452),
 (855635.170164,689252980.675069,0.105880),
 (1044216.427737,3146048.013763,0.116806),
 (188312.014193,733046871.533077,0.130722),
 (816128.822548,935423156.076277,0.100125),
 (348024.729661,1417590589.395605,0.116325),
 (714214.237318,54264954.481217,0.115321),
 (580238.354739,688848569.204684,0.106594));
CoefDl1:array[1..36,1..3] of Double=
 ((743432.101141,689050774.939877,3007.809201),
 (809860.089062,1378101549.879753,340.133436),
 (879913.413445,2067152324.819630,41.177340),
 (976066.486577,726695.323642,7.121084),
 (951453.280490,2756203099.759506,5.126671),
 (919648.669453,470537566.367726,1.735824),
 (1034603.079567,82124127.045467,1.108809),
 (1030133.219492,689777470.263519,1.074724),
 (528174.869723,39489039.515852,0.892330),
 (1096598.926726,32057758.576142,0.886229),
 (729932.556002,164248254.090934,0.787410),
 (1023764.974852,3445253874.699383,0.647938),
 (651729.789227,524802520.848943,0.583325),
 (942406.275777,442678393.803476,0.424212),
 (274115.229302,688324079.616235,0.348185),
 (863220.350953,361280962.081651,0.325047),
 (460641.093471,202205.735192,0.275747),
 (456562.306654,218513208.572150,0.240424),
 (1242554.072489,1268844945.593678,0.242549),
 (1119612.018940,771174901.985344,0.234307),
 (1232271.132613,360554266.758009,0.275493),
 (226123.644737,278430139.712542,0.187903),
 (1092453.960994,1378828245.203395,0.171821),
 (439074.769099,246372381.136401,0.234886),
 (913368.213644,109256604.286075,0.166612),
 (463815.843265,1848639116.247480,0.164044),
 (1205015.835987,50066368.469325,0.149552),
 (516052.806062,196306012.667075,0.150462),
 (795431.543005,601058581.753477,0.147453),
 (806195.980513,114181885.621608,0.176031),
 (1036125.229229,78978079.031703,0.139398),
 (209982.604200,689047216.118649,0.134256),
 (628859.324432,689054333.761105,0.134256),
 (856376.740132,649561735.424025,0.126869),
 (1005256.535712,43996096.593200,0.099991),
 (801985.823565,853299029.030810,0.116581));
var
Dl1,Dl2,Dl3,phs,Lg3:extended;
i:Integer;
begin
Lg3:=1279559.005355;
for i:=1 to 94 do
   begin
   phs:=CoefLg3[i,1]+CoefLg3[i,2]*t;
   phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
   Lg3:=Lg3+CoefLg3[i,3]*cos(phs);
   end;
Dl1:=689101072.209348;
for i:=1 to 36 do
   begin
   phs:=CoefDl1[i,1]+CoefDl1[i,2]*t;
   phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
   Dl1:=Dl1+CoefDl1[i,3]*cos(phs);
   end;
Dl2:=111.770041;
phs:=422800.492779+689050774.939877*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl2:=Dl2+119.666159*cos(phs);
phs:=506880.002490+1378101549.879753*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl2:=Dl2+28.688188*cos(phs);
phs:=577541.500661+2067152324.819630*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl2:=Dl2+5.084642*cos(phs);
phs:=647915.767497+2756203099.759506*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl2:=Dl2+0.821716*cos(phs);
phs:=658884.211535+726695.323642*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl2:=Dl2+0.457953*cos(phs);
phs:=112053.959223+32057758.576142*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl2:=Dl2+0.249492*cos(phs);
phs:=718893.548081+3445253874.699383*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl2:=Dl2+0.126888*cos(phs);
phs:=730571.630426+689777470.263519*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl2:=Dl2+0.110636*cos(phs);

phs:=91653.137292+689050774.939877*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl3:=3.057717*cos(phs);
phs:=182480.780005+1378101549.879753*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl3:=Dl3+1.365669*cos(phs);
phs:=265669.034344+2067152324.819630*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl3:=Dl3+0.388331*cos(phs);

Lg3:=Lg3+t*(Dl1+t*(Dl2+t*(Dl3-0.235078*t)));
Lg3:=Lg3-1296000.0*int(Lg3/1296000.0);
if (Lg3<0) then Lg3:=Lg3+1296000.0;
Lg3:=pi*Lg3/648000;
Result:=Lg3;
end;

function CalcB3(t:Double):Double;
const
CoefB3:array[1..23,1..3] of Double=
((777271.882199,689050774.939877,6594.564284),
(846958.351718,1378101549.879753,614.737673),
(917158.632643,2067152324.819630,64.696066),
(987621.774190,2756203099.759506,7.186472),
(1165876.785041,688324079.616235,0.913751),
(1036774.827271,689777470.263519,0.914580),
(1058255.644778,3445253874.699383,0.823221),
(782343.113187,470537566.367726,0.603337),
(1265739.882380,1268844945.593678,0.375365),
(879512.363715,109256604.286075,0.336540),
(460371.930378,218513208.572150,0.329360),
(498740.760955,1848639116.247480,0.287374),
(446565.801158,1159588341.307603,0.307947),
(243835.973934,689047216.118649,0.294311),
(662712.694255,689054333.761105,0.294309),
(1106956.947029,1378828245.203395,0.170259),
(1050274.661552,82124127.045467,0.151893),
(1142244.396176,1295977422.834286,0.149872),
(1184846.201323,771174901.985344,0.178165),
(1235250.445838,1377374854.556111,0.171769),
(758973.649390,164248254.090934,0.123998),
(150674.612156,1213853295.788819,0.130176),
(1000532.819276,606926647.894410,0.128581));
var
Db1,Db2,Db3,phs,B3:extended;
i:Integer;
begin
B3:=596.321336;
for i:=1 to 23 do
   begin
   phs:=CoefB3[i,1]+CoefB3[i,2]*t;
   phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
   B3:=B3+CoefB3[i,3]*cos(phs);
   end;
Db1:=-29.116402;
phs:=1107328.149202+689050774.939877*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Db1:=Db1+722.068825*cos(phs);
phs:=1130079.054807+1378101549.879753*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Db1:=Db1+19.947364*cos(phs);
phs:=660471.804472+2067152324.819630*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Db1:=Db1+3.036049*cos(phs);
phs:=703040.830232+2756203099.759506*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Db1:=Db1+0.878408*cos(phs);
phs:=160097.144972+688324079.616235*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Db1:=Db1+0.210471*cos(phs);
phs:=766827.151029+3445253874.699383*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Db1:=Db1+0.162636*cos(phs);

Db2:=-10.286011;
phs:=124215.538392+689050774.939877*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Db2:=Db2+34.501275*cos(phs);
phs:=115242.779232+1378101549.879753*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Db2:=Db2+0.623211*cos(phs);
phs:=408508.755520+689050774.939877*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;

Db3:=1.251008*cos(phs);
B3:=pi*(B3+t*(Db1+t*(Db2+t*Db3)))/648000.0;
Result:=B3;
end;

function CalcR3(t:Double):Double;
const
CoefR3:array[1..57,1..3] of Double=
((717742.293746,689050774.939877,0.14184953153),
(787484.877125,1378101549.879753,0.00660776357),
(857226.873905,2067152324.819630,0.00046179117),
(1146746.640674,579794170.653801,0.00008109738),
(365581.675961,1159588341.307603,0.00007485315),
(281420.108789,470537566.367726,0.00005523193),
(926968.854054,2756203100.172036,0.00003825160),
(18732.438557,524802520.848943,0.00002306539),
(1105702.306090,688324079.616235,0.00001999399),
(1015948.181920,606926647.894410,0.00002484385),
(978209.577827,689777470.263519,0.00001960198),
(435758.126032,1050331737.021528,0.00001167115),
(1033197.460545,82124127.045467,0.00001102828),
(909195.534633,109256604.286075,0.00000899077),
(1204302.650310,1268844945.593678,0.00000992252),
(433602.959848,218513208.572150,0.00000807348),
(711281.549198,164248254.090934,0.00000797910),
(309204.015342,442678393.803476,0.00000740980),
(440125.398889,1848639116.247480,0.00000692340),
(184304.380218,689047216.118649,0.00000633144),
(256834.570320,1739382511.961404,0.00000725583),
(603181.097323,689054333.761105,0.00000633140),
(170985.678761,601085008.898418,0.00000574352),
(1110307.520605,771174901.985344,0.00000526187),
(265541.466494,361280962.081651,0.00000629976),
(1072268.539706,645054678.346677,0.00000472776),
(996711.144376,3445253874.699383,0.00000348095),
(599595.898878,728539814.455728,0.00000283702),
(1084435.666800,1295977422.834286,0.00000279552),
(1053077.733616,1131729168.743353,0.00000233827),
(1151659.432354,39489039.515852,0.00000219428),
(776369.857716,1213853295.788819,0.00000269891),
(1083872.219881,689036891.193311,0.00000208333),
(599857.007266,360554266.758009,0.00000275224),
(251164.462815,1290109356.693353,0.00000275501),
(420099.316859,246372381.136401,0.00000239133),
(866026.702914,649561735.424025,0.00000223190),
(1047954.509436,1378828245.203395,0.00000182686),
(1175444.460321,1377374854.556111,0.00000186213),
(1227980.582162,798307379.225952,0.00000175995),
(863059.442919,687583500.546027,0.00000178613),
(999613.791865,689064658.686442,0.00000208336),
(671451.803660,1417590589.395605,0.00000228128),
(43926.178422,1049605041.697886,0.00000144286),
(783577.450293,853299029.030810,0.00000163534),
(317462.383400,1630125907.675329,0.00000133120),
(511104.226147,941075132.735453,0.00000141759),
(890538.169366,278430139.712542,0.00000114941),
(437648.687505,327769812.858225,0.00000118781),
(1275002.282676,1957895720.533555,0.00000102096),
(1134215.712842,1820779943.683229,0.00000128555),
(114145.231006,2319176682.615206,0.00000111538),
(334617.299204,2428433286.901281,0.00000082498),
(126962.961167,1738655816.637762,0.00000083212),
(12845.056882,328496508.181868,0.00000084470),
(360939.340021,557062485.160277,0.00000086659),
(333367.444463,967480914.652419,0.00000085312));
CoefDr1:array[1..15,1..3] of Double=
((419234.301484,689050774.939877,0.01107433340),
(488995.783162,1378101549.879753,0.00103175886),
(558746.801829,2067152324.819630,0.00010815880),
(628493.366370,2756203099.759506,0.00001194550),
(595765.102930,470537566.367726,0.00000438579),
(706095.196216,689777470.263519,0.00000395698),
(326782.535589,524802520.848943,0.00000182572),
(698220.844796,3445253874.699383,0.00000135850),
(129928.719061,218513208.572150,0.00000128204),
(403020.342357,164248254.090934,0.00000127068),
(618302.157621,4426783938.596460,0.00000118443),
(1246547.661481,688324079.616235,0.00000128362),
(705534.460571,821241270.454772,0.00000087537),
(795305.499157,771174901.985344,0.00000083026),
(918088.446535,1268844945.593678,0.00000075598));
var
Dr1,Dr2,Dr3,phs,R3:extended;
i:Integer;
begin
R3:=1.53033488276;
for i:=1 to 57 do
   begin
   phs:=CoefR3[i,1]+CoefR3[i,2]*t;
   phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
   R3:=R3+CoefR3[i,3]*cos(phs);
   end;
Dr1:=0.00012877200;
for i:=1 to 15 do
   begin
   phs:=CoefDr1[i,1]+CoefDr1[i,2]*t;
   phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
   Dr1:=Dr1+CoefDr1[i,3]*cos(phs);
   end;
   
phs:=98863.967356+689050774.939877*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr2:=0.00044242247*cos(phs);
phs:=179447.077265+1378101549.879753*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr2:=Dr2+0.00081368042*cos(phs);
phs:=252868.381372+2067152324.819630*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr2:=Dr2+0.00001274915*cos(phs);
phs:=324452.461040+2756203099.759506*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr2:=Dr2+0.00000187387*cos(phs);
phs:=1062237.659967+689050774.939877*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;

Dr3:=0.00001113107*cos(phs);
phs:=1157854.632306+1378101549.879753*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr3:=Dr3+0.00000424446*cos(phs);
phs:=1237025.377781+2067152324.819630*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr3:=Dr3+0.00000100044*cos(phs);
R3:=UA*(R3+t*(Dr1+t*(Dr2+Dr3*t)));
Result:=R3;
end;

procedure Mars(jd:double;var d3,ad3,dc3,x0,y0,z0,x3,y3,z3,eps,lg3,b3,lg0,r3:Double);
var
xa,ya,za,xb,yb,zb,xc,yc,zc,xd,yd,zd:Double;
lp:longint;
t:Double;
deps,dpsi:Double;
dt,cfi,cfe,cfs:Double;
pr3,dm3:Double;
begin
t:=(jd-2451546)/365250;
CalcNut(t,deps,dpsi);
eps:=pi*(deps+84381.448+t*((1.813*t-0.059)*t-468.15))/648000;
Terre(t,dpsi,eps,x0,y0,z0,lg0);
lg3:=Calclg3(t);
b3:=Calcb3(t);
r3:=Calcr3(t);
x3:=r3*cos(lg3+(dpsi*pi/648000))*cos(b3);
y3:=r3*(sin(lg3+(dpsi*pi/648000))*cos(b3)*cos(eps)-sin(b3)*sin(eps));
z3:=r3*(sin(lg3+(dpsi*pi/648000))*cos(b3)*sin(eps)+sin(b3)*cos(eps));
xa:=x3-x0;
ya:=y3-y0;
za:=z3-z0;
t:=(jd-2451544)/365250;
CalcNut(t,deps,dpsi);
eps:=pi*(deps+84381.448+t*((1.813*t-0.059)*t-468.15))/648000;
Terre(t,dpsi,eps,x0,y0,z0,lg0);
lg3:=Calclg3(t);
b3:=Calcb3(t);
r3:=Calcr3(t);
x3:=r3*cos(lg3+(dpsi*pi/648000))*cos(b3);
y3:=r3*(sin(lg3+(dpsi*pi/648000))*cos(b3)*cos(eps)-sin(b3)*sin(eps));
z3:=r3*(sin(lg3+(dpsi*pi/648000))*cos(b3)*sin(eps)+sin(b3)*cos(eps));
xc:=x3-x0;
yc:=y3-y0;
zc:=z3-z0;
t:=(jd-2451545)/365250;
CalcNut(t,deps,dpsi);
eps:=pi*(deps+84381.448+t*((1.813*t-0.059)*t-468.15))/648000;
Terre(t,dpsi,eps,x0,y0,z0,lg0);
lg3:=Calclg3(t);
b3:=Calcb3(t);
r3:=Calcr3(t);
x3:=r3*cos(lg3+(dpsi*pi/648000))*cos(b3);
y3:=r3*(sin(lg3+(dpsi*pi/648000))*cos(b3)*cos(eps)-sin(b3)*sin(eps));
z3:=r3*(sin(lg3+(dpsi*pi/648000))*cos(b3)*sin(eps)+sin(b3)*cos(eps));
xb:=x3-x0;
yb:=y3-y0;
zb:=z3-z0;
xd:=xb;
yd:=yb;
zd:=zb;
for lp:=1 to MAXITER do
   begin
   dt:=sqrt(xd*xd+yd*yd+zd*zd)/JLM;
   cfi:=dt*(dt+1)/2;
   cfe:=1-dt*dt;
   cfs:=dt*(dt-1)/2;
   xd:=cfi*xa+cfe*xb+cfs*xc-x0;
   yd:=cfi*ya+cfe*yb+cfs*yc-y0;
   zd:=cfi*za+cfe*zb+cfs*zc-y0;
   end;
dt:=sqrt(xd*xd+yd*yd+zd*zd)/JLM;
cfi:=dt*(dt+1)/2;
cfe:=1-dt*dt;
cfs:=dt*(dt-1)/2;
x3:=cfi*xa+cfe*xb+cfs*xc;
y3:=cfi*ya+cfe*yb+cfs*yc;
z3:=cfi*za+cfe*zb+cfs*zc;
if (x3<>0) then ad3:=arctan(y3/x3)*12/pi else ad3:=6*y3/abs(y3);
if (x3<0) then ad3:=ad3+12;
if (ad3<0) then ad3:=ad3+24;
dc3:=arctan(z3/sqrt(x3*x3+y3*y3))*180/pi;
d3:=sqrt(x3*x3+y3*y3+z3*z3);
pr3:=648000*arctan(REQT/sqrt(d3*d3-REQT*REQT))/pi;
dm3:=1296000*arctan(3397/sqrt(d3*d3-11539609))/pi;
end;

//    w  Phase Lat Dequ DPol
//    lc aph   bc  dae  dap
procedure MarsPhys(qu:TDateTime;var ad,dc,aph,lc,bc,dae,dap,th0,ap,Apl:double);
var
fev,fil,dlg,s,th,ls,bs,elg:Double;
dclv,dclh,acd,bcd,ccd,crd,dbd,fel,l,b,mrg,lgp,ecl:Double;
a0,d0,w,aas,ds,ai,di,x,y,z,u,v,xs,ys,zs,us,vs,ws,p,q:Double;
iis:longint;
jd:Double;  // Jour Julien
t:Double;
d3,x0,y0,z0,x3,y3,z3,eps,lg3,b3,lg0,r3:Double;
wrk:Double;
cor:Longint;
begin
apl:=3375/3397;
jd:=jj(qu);
t:=(jd-2451545.0)/36525.0;
a0:=pi*(317681-108*t)/180000;
d0:=pi*(52886-61*t)/180000;
ReducPole(a0,d0,jd);
Mars(jd,d3,ad,dc,x0,y0,z0,x3,y3,z3,eps,lg3,b3,lg0,r3);
w:=176.901+350.8919830*(jd-2451545-(d3/JLM));
ai:=pi*ad/12;
di:=pi*dc/180;
x:=x0+x3;
y:=y0+y3;
z:=z0+z3;
if (x<>0) then aas:=arctan(y/x) else aas:=-pi*y/abs(2*y);
if (x>0) then aas:=aas+pi;
if (aas<0) then aas:=aas+2*pi;
ds:=-arctan(z/sqrt(x*x+y*y));
x:=cos(ai-a0)*sin(d0)*cos(di)-sin(di)*cos(d0);
y:=sin(ai-a0)*cos(di);
z:=-(cos(ai-a0)*cos(d0)*cos(di)+sin(di)*sin(d0));
u:=sin(d0)*cos(di)-cos(ai-a0)*sin(di)*cos(d0);
v:=sin(a0-ai)*cos(d0);
xs:=sin(ds)*cos(d0)-cos(a0-aas)*sin(d0)*cos(ds);
ys:=sin(a0-aas)*cos(ds);
zs:=cos(a0-aas)*cos(d0)*cos(ds)+sin(ds)*sin(d0);
us:=sin(ds)*cos(di)-cos(ds)*sin(di)*cos(aas-ai);
vs:=sin(aas-ai)*cos(ds);
ws:=-(cos(ds)*cos(di)*cos(aas-ai)+sin(ds)*sin(di));
if (x<>0) then lc:=arctan(y/x)*180/pi else lc:=90*y/abs(y);
if (x<0) then lc:=lc+180;
lc:=w-lc-90;
lc:=lc-360*int(lc/360);
if (lc<0) then lc:=lc+360;
wrk:=sqrt(x*x+y*y);
if (wrk<>0) then bc:=arctan(z/wrk)*180/pi else bc:=90*z/abs(z);
if (u<>0) then ap:=arctan(v/u)*180/pi else if (v=0) then ap:=0 else ap:=90*v/abs(v);
if (u<0) then ap:=ap+180;
if (ap<0) then ap:=ap+360;
if (xs<>0) then ls:=arctan(ys/xs)*180/pi else ls:=90*ys/abs(ys);
if (xs<0) then ls:=ls+180;
ls:=w-ls-90;
ls:=ls-360*int(ls/360);
if (ls<0) then ls:=ls+360;
wrk:=sqrt(xs*xs+ys*ys);
if (wrk<>0) then bs:=arctan(zs/wrk)*180/pi else bs:=90*zs/abs(zs);
if (us<>0) then th0:=arctan(vs/us)*180/pi else if (vs=0) then th0:=0 else th0:=90*vs/abs(vs);
if (us<0) then th0:=th0+180;
th0:=th0-180;
if (th0<0) then th0:=th0+360;
fil:=(1+ws)/2;
dae:=arctan(3397/sqrt(d3*d3-11539609))*1296000/pi;
wrk:=bc*pi/180;
dap:=3397*sqrt(sin(wrk)*sin(wrk)+apl*apl*cos(wrk)*cos(wrk));
dap:=arctan(dap/sqrt(d3*d3-dap*dap))*1296000/pi;
x:=y3*z0-y0*z3;
u:=x0*z3-x3*z0;
v:=x3*y0-x0*y3;
y:=u*cos(eps)+v*sin(eps);
z:=v*cos(eps)-u*sin(eps);
u:=z*sqrt(x*x+y*y+z*z)/abs(z);
v:=x3*(x3+x0)+y3*(y3+y0)+z3*(z3+z0);
if (v<>0) then aph:=180*arctan(u/v)/pi else aph:=90*u/abs(u);
if (v<0) then aph:=aph+180;
if (aph>180) then aph:=aph-360;
w:=-(x0*x3+y0*y3+z0*z3);
if (w<>0) then elg:=180*arctan(u/w)/pi else elg:=90*u/abs(u);
if (w<0) then elg:=elg+180;
if (elg>180) then elg:=elg-360;
v:=x3*(x3+x0)+y3*(y3+y0)*cos(eps)*cos(eps)+z3*(z3+z0)*sin(eps)*sin(eps)+(z3*(y3+y0)+y3*(z3+z0))*cos(eps)*sin(eps);
if (v<>0) then dlg:=180*arctan(z/v)/pi else dlg:=90*z/abs(z);
if (v<0) then dlg:=dlg+180;
if (dlg>180) then dlg:=dlg-360;
w:=-(x3*x0+y3*y0*cos(eps)*cos(eps)+z3*z0*sin(eps)*sin(eps)+(z3*y0+y3*z0)*cos(eps)*sin(eps));
if (w<>0) then ecl:=180*arctan(z/w)/pi else ecl:=90*z/abs(z);
if (w<0) then ecl:=ecl+180;
if (ecl>180) then ecl:=ecl-360;
q:=(10470426-t*(1689431+t*(82811-t*(3613-t*(22-24*t)))))/1000000000.0;
p:=(12284493+t*(1371039-t*(107356+t*(2604+t*(68+11*t)))))/1000000000.0;
xs:=cos(a0)*cos(d0);
ys:=sin(a0)*cos(d0)*cos(eps)+sin(d0)*sin(eps);
zs:=sin(d0)*cos(eps)-sin(a0)*cos(d0)*sin(eps);
us:=2*p*sqrt(1-p*p-q*q);
vs:=-2*q*sqrt(1-p*p-q*q);
ws:=1-2*p*p-2*q*q;
x:=zs*vs-ys*ws;
y:=xs*ws-zs*us;
z:=ys*us-xs*vs;
wrk:=sqrt(x*x+y*y+z*z);
x:=x/wrk;
y:=y/wrk;
z:=z/wrk;
u:=z*vs-y*ws;
v:=x*ws-z*us;
w:=y*us-x*vs;
p:=(x*cos(lg3)+y*sin(lg3))*cos(b3)+z*sin(b3);
q:=(u*cos(lg3)+v*sin(lg3))*cos(b3)+w*sin(b3);
if (p<>0) then lgp:=arctan(q/p)*180/pi else lgp:=90*q/abs(q);
if (p<0) then lgp:=lgp+180;
if (lgp<0) then lgp:=lgp+360;
iis:=trunc(lgp/90) mod 4;
cor:=trunc(jd+1.5) mod 7;
// writeln('Jour julien                                     : ',jd:20:10);
// writeln('Angle de phase (i)                              : ',aph:8:4);
// writeln('Angle de position du milieu de la phase (th‚ta) : ',th0:8:4);
// writeln('Fraction illumin‚e du disque (k)                : ',fil:8:6);
// writeln('Longitude ar‚ographique de la Terre (L0)        : ',lc:8:4);
// writeln('Latitude ar‚ographique de la Terre (D)          : ',bc:8:4);
// writeln('Angle de position du p“le (P)                   : ',ap:8:4);
// writeln('Longitude ar‚ographique du Soleil               : ',ls:8:4);
// writeln('Latitude ar‚ographique du Soleil                : ',bs:8:4);
// writeln('DiamŠtre apparent ‚quatorial (secondes d''arc)   : ',dae:8:4);
// writeln('DiamŠtre apparent polaire (secondes d''arc)      : ',dap:8:4);
// writeln('Longitude ‚cliptique h‚liocentrique (lambda)    : ',lg3*180/pi:8:4);
// writeln('Latitude ‚cliptique h‚liocentrique (b‚ta)       : ',b3*180/pi:8:4);
// writeln('Longitude ‚cliptique de la Terre                : ',lg0*180/pi:8:4);
// write('Longitude saisonniŠre de Mars                   : ',lgp:8:4);
// case is of
//   0 : writeln(' (Printemps).');
//   1 : writeln(' (Et‚).');
//   2 : writeln(' (Automne).');
//   3 : writeln(' (Hiver).');
//  end;
// writeln('Distance au Soleil (r, en UA)                   : ',r3/UA:8:5);
// writeln('Distance … la Terre (delta, en UA)              : ',d3/UA:8:5);
// writeln('Elongation                                      : ',elg:9:4);
// writeln('Angle de phase ‚cliptique                       : ',dlg:8:4);
// writeln('Elongation ‚cliptique                           : ',ecl:9:4);
end;

function Calclg5(t:Double):Double;
var
dl1,dl2,dl3,dl4,dl5,lg5:Double;

procedure Clclga(t:Double;var Lg5,Dl1:Double);
const
CoefLg5:array[1..121,1..3] of Double=
((817231.661630,43996096.593200,22911.192924),
(945892.275200,1467274.393850,2916.895734),
(107488.769372,42528822.199350,821.716469),
(681354.334430,87992193.186400,723.513458),
(50861.532788,21264411.092951,426.589232),
(792071.456505,45463370.987050,163.508769),
(963209.069908,22731685.493525,49.483624),
(90177.165465,86524918.792550,34.185469),
(1189948.440656,65260507.692875,30.747884),
(193494.856715,130521015.385750,32.631711),
(322842.732764,811064.830947,30.134385),
(917653.930800,2934548.787699,27.145084),
(560359.656644,131988289.779600,31.050091),
(1233709.134800,2278339.224797,26.825367),
(645484.252321,41717757.162138,22.122037),
(48796.124571,109256604.286075,12.093733),
(867927.574604,656209.562902,10.783052),
(363703.638174,57142569.307735,12.636417),
(655484.636501,89459467.580250,10.353788),
(127835.551654,41061547.805501,9.472796),
(463023.018293,13146472.714535,8.262683),
(202717.846124,19797136.705826,6.092681),
(664755.771389,28571284.653868,7.990072),
(419055.070270,151785426.485426,5.076532),
(159838.508702,195781523.078625,6.743807),
(673620.672227,107789329.892226,3.626430),
(1135498.001950,174517111.978950,3.383079),
(829869.275131,66727782.086725,2.869837),
(901926.515603,63793233.299026,3.260306),
(585228.521032,85713853.961603,2.317416),
(766682.472663,46930645.380899,2.098241),
(658293.769905,43185031.762253,1.750452),
(862894.857925,504870.355391,2.242587),
(104660.598211,261042030.771501,1.973443),
(1032860.958055,198675.879834,1.627852),
(360374.334790,217045934.178301,1.416967),
(329795.419859,9938.686072,1.349941),
(442227.927247,175984386.372800,1.544534),
(474181.963052,85057644.398701,1.307678),
(1083461.492718,46274435.817997,1.533752),
(705717.194106,36130593.385756,1.758773),
(637892.491689,15424811.939332,1.196041),
(200173.458459,43339887.030298,1.288957),
(917752.354060,24198959.887374,1.092917),
(313160.140544,1765879.942993,1.119282),
(1129355.889326,153252700.879275,0.978271),
(266061.831972,26292945.429071,0.925184),
(438681.007772,72261186.771511,1.126944),
(611550.510826,28265090.178311,0.986057),
(621447.980471,173049837.585101,0.732125),
(215416.083148,101138665.900935,0.931960),
(317499.760757,70289042.022271,0.716591),
(50749.473649,107518.595723,0.708474),
(720868.136619,44652306.156102,0.637360),
(198297.737564,42023951.843960,0.664554),
(469910.642999,44807161.424147,0.767940),
(530476.685287,133455564.173450,0.663230),
(50979.621259,326302538.464376,0.681078),
(303230.993986,282306441.871176,0.513839),
(488937.823117,72567381.247068,0.591336),
(867183.500084,41411562.892847,0.454247),
(82548.018931,43689902.117643,0.572952),
(1239821.048829,54864230.082526,0.421812),
(99728.663550,239777619.671825,0.428336),
(277459.693374,129053740.991901,0.430382),
(1132646.032532,602450.265041,0.376338),
(1012766.723114,2584533.700353,0.467415),
(264642.323225,8117938.385140,0.428327),
(384283.311452,154855.268045,0.358723),
(722637.208084,30849623.878665,0.380950),
(200602.739810,864824.128809,0.378519),
(1285241.255249,40250482.974554,0.301287),
(90767.895451,1117259.306504,0.339390),
(316676.955480,1161079.918293,0.304294),
(885804.746859,4401823.181549,0.288082),
(839144.970026,2123483.956752,0.270791),
(552625.495161,238310345.277976,0.241914),
(1183123.274237,10868133.489739,0.307951),
(407556.108456,962404.038459,0.252412),
(1153902.141197,218513208.572150,0.234620),
(246998.236073,347566949.564051,0.211838),
(1101604.502327,114285138.615471,0.243714),
(709164.631863,110723878.679925,0.225396),
(34248.258118,306194.475557,0.227714),
(1294802.168939,391563046.157251,0.257767),
(1197146.362235,23542750.324472,0.185533),
(452153.830658,18329862.311976,0.214425),
(227928.104836,39439418.143606,0.231918),
(827444.901299,197248797.472475,0.219816),
(386791.018523,7865503.207444,0.188588),
(1132003.235521,23075.789516,0.172831),
(472290.234787,129709950.554803,0.172151),
(935754.524758,62325958.905176,0.200050),
(1024132.952277,55675294.913886,0.207566),
(449750.662151,150318152.091576,0.155711),
(584387.776685,56836374.832179,0.198695),
(630076.848007,90926741.974099,0.169886),
(1049710.899080,283773716.265025,0.152405),
(1053890.934473,13452667.190092,0.147754),
(1004192.889724,43820.611789,0.145229),
(765302.294357,3089404.055744,0.143890),
(796872.239853,57448763.783292,0.183105),
(151430.258366,305038127.364701,0.140446),
(5522.905892,14613747.108385,0.137168),
(416996.399811,29382349.484815,0.135479),
(332933.029907,58609843.701585,0.156277),
(720881.787482,98860326.676139,0.130262),
(533635.129561,87181128.355453,0.128996),
(709509.126506,106322055.498376,0.142968),
(918197.977762,7306873.554193,0.162993),
(684282.522615,12840278.238979,0.131316),
(1137329.136350,53759.297861,0.109195),
(656913.602290,1665950.273787,0.109343),
(506739.186800,4556678.449594,0.112398),
(880233.713705,20453346.268728,0.104193),
(199659.064753,194314248.684776,0.113796),
(492233.270969,303570852.970851,0.101664),
(310005.880443,43491226.237809,0.125987),
(554265.611833,80126689.978956,0.124926),
(1244116.623373,456823553.850126,0.103431),
(161205.919808,39594273.411651,0.111723));
CoefDl1:array[1..56,1..3] of Double=
((377094.442307,43996096.593200,2674.955463),
(595074.247428,1467274.393850,1164.050414),
(222910.502609,87992193.186400,202.805807),
(469809.167412,42528822.199350,222.103406),
(421044.753982,45463370.987050,83.031044),
(263925.437177,21264411.099675,41.132779),
(566981.509620,2934548.787699,21.681950),
(83522.972975,131988289.779600,14.313196),
(503686.482418,86524918.792550,9.907569),
(602636.910137,22731685.493525,8.366771),
(752795.652599,811064.830947,7.773357),
(498530.179882,656209.562902,6.981412),
(260422.697697,89459467.580250,6.811276),
(480059.302818,41061547.805501,6.335180),
(735116.802984,2278339.224797,4.028426),
(542071.620004,19797136.705826,2.576965),
(404464.316686,46930645.380899,1.901108),
(911049.474345,109256604.286075,1.455378),
(1273516.234620,41717757.368403,1.340008),
(1260459.947765,63793233.299026,1.294524),
(1245835.717595,175984386.372800,1.004186),
(952340.789662,13146472.714535,0.966097),
(1028801.387870,107789329.892226,0.986979),
(436679.445168,66727782.086725,0.860145),
(268040.201297,43185031.762253,0.840797),
(816507.854457,85057644.398701,0.709192),
(749558.877795,65260507.692875,0.700731),
(777975.307646,151785426.485426,0.692918),
(590077.613378,43339887.030298,0.684661),
(477930.158515,130521015.385750,0.727061),
(563645.562992,24198959.887374,0.596990),
(112093.848481,133455564.173450,0.548254),
(339158.909965,44652306.156102,0.475426),
(1184782.665583,504870.355391,0.579421),
(611601.854765,46274435.817997,0.395342),
(840931.757765,174517111.978950,0.356613),
(535762.938999,4401823.181549,0.344732),
(471480.602828,2123483.956752,0.281197),
(709774.433053,153252700.879275,0.270958),
(844723.420985,44807161.424147,0.263685),
(1270882.188910,85713853.961603,0.224544),
(718620.974354,217045934.178301,0.193701),
(814241.667072,18329862.311976,0.190758),
(975313.723810,172637307.972606,0.201281),
(251542.664353,90926741.974099,0.178625),
(642039.440827,129053740.991901,0.172155),
(1287935.887878,62325958.905176,0.160037),
(377030.640263,40250482.974554,0.126970),
(885586.319269,26292945.429071,0.127678),
(59737.873999,962404.038459,0.138416),
(1035221.565867,28265090.178311,0.117404),
(1057372.331591,101138665.900935,0.111713),
(58489.152763,15424811.939332,0.112590),
(300664.795041,110723878.679925,0.106072),
(1164895.019958,1972144.749240,0.135811),
(510774.678364,39594273.411651,0.119180));
var
phs:Double;
i:Integer;
begin
Lg5:=180278.233545;
for i:=1 to 121 do
   begin
   phs:=CoefLg5[i,1]+CoefLg5[i,2]*t;
   phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
   Lg5:=Lg5+CoefLg5[i,3]*cos(phs);
   end;
Dl1:=44046396.436493;
for i:=1 to 56 do
   begin
   phs:=CoefDl1[i,1]+CoefDl1[i,2]*t;
   phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
   Dl1:=Dl1+CoefDl1[i,3]*cos(phs);
   end;
end;

procedure Clclgb(t:Double;var Dl2,Dl3,Dl4,Dl5:Double);
const
CoefDl2:array[1..30,1..3] of Double=
((838449.951686,42528822.199350,31.510887),
(53171.513962,45463370.987050,21.928828),
(1115817.512920,87992193.186400,21.874339),
(215743.822226,2934548.787699,8.797953),
(602004.550398,21264411.099675,2.507204),
(950761.389233,131988289.779600,2.402333),
(1173915.617166,89459467.580250,2.231717),
(130708.321797,656209.562902,2.104064),
(833735.658379,41061547.805501,2.154960),
(905142.381774,86524918.792550,1.306857),
(1149520.230053,811064.830947,1.133072),
(261628.283795,22731685.493525,0.942453),
(43182.567025,46930645.380899,0.876832),
(884548.082064,19797136.705826,0.564627),
(284932.448903,2278339.224797,0.333264),
(322983.633242,63793233.299026,0.267101),
(800556.855301,175984386.372800,0.241346),
(1010704.158508,133455564.173450,0.217434),
(184133.609629,4401823.181549,0.208259),
(1160365.667302,85057644.398701,0.196420),
(211375.137105,24198959.887374,0.169030),
(982188.594747,43339887.030298,0.154404),
(1247965.885371,44652306.156102,0.170637),
(600423.570706,65260507.692875,0.197311),
(72563.556450,66727782.086725,0.131382),
(1182872.514341,43185031.762253,0.175036),
(1005577.749114,130521015.385750,0.125093),
(99621.653602,2123483.956752,0.137082),
(94157.022367,107789329.892226,0.138577),
(566672.418893,109256604.286075,0.109900));
var
phs:Double;
i:Integer;
begin
Dl2:=186.859931;
phs:=243367.411503+1467274.393850*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl2:=dl2+240.177176*cos(phs);
phs:=15315.700409+43996096.593200*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl2:=dl2+189.600351*cos(phs);
phs:=0.000000+0.000000*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
for i:=1 to 30 do
   begin
   phs:=CoefDl2[i,1]+CoefDl2[i,2]*t;
   phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
   Dl2:=Dl2+CoefDl2[i,3]*cos(phs);
   end;

phs:=1183847.320708+1467274.393850*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl3:=33.082264*cos(phs);
phs:=945805.973449+43996096.593200*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl3:=Dl3+8.765827*cos(phs);
phs:=981989.718433+45463370.987050*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl3:=Dl3+3.932488*cos(phs);
phs:=1219698.827330+42528822.199350*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl3:=Dl3+3.023196*cos(phs);
phs:=1159152.792763+2934548.787699*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl3:=Dl3+2.396882*cos(phs);
phs:=744237.522993+87992193.186400*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl3:=Dl3+2.199981*cos(phs);
phs:=796364.229152+89459467.580250*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl3:=Dl3+0.493751*cos(phs);
phs:=1189789.962496+41061547.805501*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl3:=Dl3+0.488796*cos(phs);
phs:=1055335.627173+656209.562902*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl3:=Dl3+0.341659*cos(phs);
phs:=978370.790877+46930645.380899*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl3:=Dl3+0.271051*cos(phs);
phs:=564329.457937+131988289.779600*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl3:=Dl3+0.312186*cos(phs);
phs:=978287.269818+21264411.099675*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl3:=Dl3+0.127121*cos(phs);
phs:=47131.692828+86524918.792550*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl3:=Dl3+0.130700*cos(phs);

Dl4:=-0.235045;
phs:=824700.837780+1467274.393850*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl4:=Dl4+3.427902*cos(phs);
phs:=615569.466460+45463370.987050*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl4:=Dl4+0.530321*cos(phs);
phs:=804930.725515+2934548.787699*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl4:=Dl4+0.487494*cos(phs);
phs:=565394.160455+43996096.593200*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl4:=Dl4+0.308197*cos(phs);
phs:=312523.646000+42528822.199350*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl4:=Dl4+0.226062*cos(phs);
phs:=355024.950911+87992193.186400*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl4:=Dl4+0.141065*cos(phs);

phs:=466000.351341+1467274.393850*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dl5:=0.254974*cos(phs);
end;

begin
Clclga(t,lg5,dl1);
Clclgb(t,dl2,dl3,dl4,dl5);
lg5:=lg5+t*(dl1+t*(dl2+t*(dl3+t*(dl4+t*dl5))));
lg5:=lg5-1296000.0*int(lg5/1296000.0);
if (lg5<0) then lg5:=lg5+1296000.0;
lg5:=pi*lg5/648000.0;
Result:=lg5;
end;

function CalcB5(t:Double):Double;
const
CoefB5:array[1..42,1..3] of Double=
((743139.978176,43996096.593200,8932.664668),
(588346.617482,87992193.186400,495.753962),
(718712.194069,45463370.987050,63.660244),
(118184.181009,42528822.199350,70.369431),
(436964.974638,131988289.779600,30.391201),
(1194279.806791,86524918.792550,20.454596),
(976879.794512,1467274.393850,14.425261),
(1120647.656557,65260507.692875,9.916360),
(1024131.427735,22731685.493525,9.876767),
(563630.447676,89459467.580250,7.079266),
(1240279.636432,21264411.099675,3.106614),
(1161475.664477,109256604.286075,2.187022),
(1073474.174474,130521015.385750,1.998852),
(288041.949989,175984386.372800,1.943118),
(784429.863193,66727782.086725,1.459623),
(1058446.015530,41717757.368403,1.139227),
(692825.774207,46930645.380899,0.824389),
(411945.396718,133455564.173450,0.651927),
(747857.507136,43185031.762253,0.658769),
(1007909.843853,46274435.817997,0.586811),
(95934.323271,44807161.424147,0.648136),
(441174.580287,2278339.224797,0.487697),
(1227239.727933,174517111.978950,0.444200),
(437289.420719,85713853.961603,0.430107),
(609226.855967,13146472.714535,0.369127),
(150617.578868,41061547.805501,0.427407),
(412162.442451,151785426.485426,0.286997),
(1081860.599323,153252700.879275,0.278218),
(132870.879699,101138665.900935,0.289977),
(642591.480016,107789329.892226,0.250960),
(947859.323956,2934548.787699,0.287203),
(641259.847411,44652306.156102,0.238285),
(198553.477106,43339887.030298,0.235592),
(924405.307087,24198959.887374,0.198790),
(271635.795938,57142569.307735,0.166235),
(631146.550299,110723878.679925,0.150474),
(1015603.834669,63793233.299026,0.142861),
(596881.958772,30849623.878665,0.153259),
(449661.947400,72567381.247068,0.140343),
(139699.247775,219980482.966000,0.127336),
(538275.633416,90926741.974099,0.116742),
(1193707.802929,19797136.705826,0.100789));
CoefDb1:array[1..24,1..3] of Double=
((1099989.569881,43996096.593200,820.016046),
(1258048.669299,87992193.186400,38.306689),
(475617.890964,42528822.199350,30.528402),
(349979.108947,45463370.987050,19.892139),
(258716.944066,86524918.792550,7.543436),
(1219368.775720,131988289.779600,5.603487),
(175658.443337,89459467.580250,3.001790),
(601820.593062,1467274.393850,2.662043),
(89873.864321,65260507.692875,1.758676),
(333905.087832,46930645.380899,0.586588),
(1096450.599442,175984386.372800,0.602675),
(802089.859441,21264411.099675,0.567414),
(189576.347170,130521015.385750,0.614104),
(10757.011939,133455564.173450,0.355516),
(248985.243669,109256604.286075,0.263464),
(504011.381456,41061547.805501,0.342888),
(1074330.502749,22731685.493525,0.326352),
(506783.453521,44807161.424147,0.226559),
(568959.132345,43339887.030298,0.168640),
(589996.504497,2934548.787699,0.167095),
(341445.857648,41717757.368403,0.141617),
(376249.217672,66727782.086725,0.122276),
(258919.098623,44652306.156102,0.134404),
(258394.960737,43185031.762253,0.125871));
var
Db1,Db2,Db3,Db4,phs,B5:extended;
i:Integer;
begin
B5:=174.801047;
for i:=1 to 42 do
   begin
   phs:=CoefB5[i,1]+CoefB5[i,2]*t;
   phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
   B5:=B5+CoefB5[i,3]*cos(phs);
   end;
Db1:=-102.057023;
for i:=1 to 24 do
   begin
   phs:=CoefDb1[i,1]+CoefDb1[i,2]*t;
   phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
   Db1:=Db1+CoefDb1[i,3]*cos(phs);
   end;
Db2:=2.776462;
phs:=104127.471612+43996096.593200*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Db2:=Db2+42.552382*cos(phs);
phs:=824715.744230+42528822.199350*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Db2:=Db2+7.672133*cos(phs);
phs:=1275108.280949+45463370.987050*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Db2:=Db2+3.356254*cos(phs);
phs:=626868.260278+86524918.792550*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Db2:=Db2+1.455904*cos(phs);
phs:=1051803.405257+87992193.186400*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Db2:=Db2+0.752953*cos(phs);
phs:=1088870.282767+89459467.580250*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Db2:=Db2+0.679915*cos(phs);
phs:=789667.347916+131988289.779600*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Db2:=Db2+0.452411*cos(phs);
phs:=215077.724829+1467274.393850*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Db2:=Db2+0.287519*cos(phs);
phs:=1270036.339645+46930645.380899*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Db2:=Db2+0.214474*cos(phs);
phs:=408392.792035+65260507.692875*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Db2:=Db2+0.191746*cos(phs);
phs:=855492.263506+41061547.805501*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Db2:=Db2+0.146947*cos(phs);
phs:=594795.165924+130521015.385750*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Db2:=Db2+0.107107*cos(phs);
phs:=914557.950853+133455564.173450*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Db2:=Db2+0.100989*cos(phs);

Db3:=0.821039;
phs:=410480.041994+43996096.593200*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Db3:=Db3+1.374243*cos(phs);
phs:=1175252.141200+42528822.199350*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Db3:=Db3+1.304316*cos(phs);
phs:=894735.073928+45463370.987050*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Db3:=Db3+0.387444*cos(phs);
phs:=998536.607113+86524918.792550*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Db3:=Db3+0.189421*cos(phs);
phs:=705733.983300+89459467.580250*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Db3:=Db3+0.106325*cos(phs);
phs:=230848.301192+42528822.199350*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;

Db4:=1.658041*cos(phs);

B5:=pi*(B5+t*(Db1+t*(Db2+t*(Db3+t*Db4))))/648000.0;
Result:=B5;
end;

function CalcR5(t:Double):Double;
const
CoefR5:array[1..79,1..3] of Double=
((493439.498625,43996096.593200,0.52921382465),
(1079898.578548,42528822.199350,0.01873679934),
(339848.176501,87992193.186400,0.01464663959),
(1224222.930369,65260507.692875,0.00821891059),
(1034485.304347,21264411.099675,0.00547506899),
(468457.971129,45463370.987050,0.00371684449),
(647474.102929,1467274.393850,0.00361778433),
(1176548.177612,130521015.385750,0.00140617548),
(679258.049862,22731685.493525,0.00108974737),
(1225418.435155,86524918.792550,0.00069007015),
(193966.805848,131988289.779600,0.00061053350),
(321223.171994,41717757.368403,0.00048913044),
(40259.900746,57142569.307735,0.00034143794),
(1128443.004527,195781523.078625,0.00032401718),
(95602.013307,151785426.485426,0.00020936573),
(313734.113880,89459467.580250,0.00020839118),
(1099918.769575,41061547.805501,0.00020746678),
(631054.082840,109256604.286075,0.00015298457),
(537182.732370,66727782.086725,0.00014296479),
(1233569.606601,174517111.978950,0.00011993314),
(357056.232757,107789329.892226,0.00011380261),
(340114.804548,28571284.653868,0.00012884128),
(1207043.740110,19797136.705826,0.00007752769),
(1073558.532434,261042030.771501,0.00009796061),
(36577.268415,217045934.178301,0.00006465967),
(619688.533947,2934548.787699,0.00006770621),
(300155.795404,85713853.961603,0.00005850443),
(123217.508865,13146472.714535,0.00005307481),
(443302.335165,46930645.380899,0.00004695746),
(338295.576741,43185031.762253,0.00004043988),
(160919.825925,85057644.398701,0.00003688132),
(762207.200882,46274435.817997,0.00003376457),
(286221.455866,173049837.585101,0.00002885348),
(1172549.276695,43339887.030298,0.00002976033),
(1020080.843748,326302538.464376,0.00003419551),
(381773.060641,36130593.385756,0.00003460943),
(114243.367448,72261186.771511,0.00003400616),
(729871.860145,153252700.879275,0.00002507630),
(1275767.110443,282306441.871176,0.00002448325),
(611697.301092,24198959.887374,0.00002406138),
(37046.722464,175984386.372800,0.00002881181),
(3111.684869,70289042.022271,0.00002173959),
(1042485.579438,2278339.224797,0.00002024483),
(484014.896046,63793233.299026,0.00001740254),
(1223896.233469,129053740.991901,0.00001861387),
(6122.854005,811064.830947,0.00001888436),
(241953.699162,15424811.939332,0.00001610859),
(397241.541485,44652306.156102,0.00001462631),
(1170904.376772,42023951.843960,0.00001474547),
(1224531.047825,26292945.429071,0.00001395109),
(157409.724706,44807161.424147,0.00001781165),
(1191619.065817,101138665.900935,0.00001817186),
(288904.626888,28265090.178311,0.00001472392),
(159309.889501,133455564.173450,0.00001304089),
(1184003.818517,239777619.671825,0.00001149773),
(921400.985980,54864230.082939,0.00001126667),
(615520.143202,218513208.572150,0.00001277489),
(155288.384164,72567381.247068,0.00001207053),
(234249.299327,238310345.277976,0.00001071399),
(1219506.659736,347566949.564051,0.00001020922),
(1054430.995980,43689902.117643,0.00001315042),
(967761.757175,391563046.157251,0.00001295553),
(374917.469707,30849623.878665,0.00001099037),
(542747.878453,41411562.892847,0.00000998462),
(466143.713653,197248797.472475,0.00000985869),
(756952.222025,114285138.615471,0.00000932434),
(124372.985273,150318152.091576,0.00000664481),
(962504.685233,40250482.974554,0.00000659850),
(1159397.974745,194314248.684776,0.00000917740),
(1225642.459656,305038127.364701,0.00000626382),
(379671.999096,98860326.676139,0.00000482230),
(576249.449410,656209.562902,0.00000487689),
(172948.409476,303570852.970851,0.00000470086),
(703545.741662,55675294.913886,0.00000553128),
(260808.092457,56836374.832179,0.00000534397),
(388187.446009,106322055.498376,0.00000472572),
(916456.089913,456823553.850126,0.00000517196),
(471576.368371,57448763.783292,0.00000494340),
(1197638.274263,39439418.143606,0.00000489825));
CoefDr1:array[1..37,1..3] of Double=
((53306.076212,43996096.593200,0.06182981282),
(146684.496977,42528822.199350,0.00506577574),
(1195584.606097,87992193.186400,0.00341394136),
(97389.412229,45463370.987050,0.00188491375),
(290307.121525,1467274.393850,0.00143891176),
(1241187.064282,21264411.099675,0.00049621111),
(1050394.562514,131988289.779600,0.00020928189),
(242485.164070,86524918.792550,0.00019952612),
(331714.160386,22731685.493525,0.00018839639),
(1225894.156029,89459467.580250,0.00012892827),
(156526.532400,41061547.805501,0.00013876565),
(265777.165391,2934548.787699,0.00005396699),
(179025.257733,66727782.086725,0.00004869308),
(81060.799384,46930645.380899,0.00004247455),
(259591.417064,19797136.705826,0.00003252084),
(447040.613355,151785426.485426,0.00002856006),
(950218.966044,41717757.368403,0.00002909411),
(708854.908202,107789329.892226,0.00003081408),
(505460.580721,85057644.398701,0.00001987689),
(1242525.548708,43185031.762253,0.00001941309),
(266477.194737,43339887.030298,0.00001581446),
(888592.543057,175984386.372800,0.00001339511),
(258442.471624,24198959.887374,0.00001315590),
(385002.901252,65260507.692875,0.00001203085),
(15526.061139,44652306.156102,0.00001091088),
(1062621.437044,133455564.173450,0.00000954403),
(98989.325200,130521015.385750,0.00000966012),
(388750.837325,217045934.178301,0.00000881827),
(289234.172483,46274435.817997,0.00000874215),
(202848.599212,109256604.286075,0.00000897512),
(631948.992776,173049837.585101,0.00000784866),
(285110.264169,129053740.991901,0.00000739892),
(625616.228636,13146472.714535,0.00000612961),
(854684.896746,63793233.299026,0.00000658210),
(355785.104425,153252700.879275,0.00000649600),
(525818.855156,44807161.424147,0.00000599236),
(439259.096376,811064.830947,0.00000502886));
var
Dr1,Dr2,Dr3,Dr4,phs,R5:extended;
i:Integer;
begin
R5:=9.55758135801;
for i:=1 to 80 do
   begin
   phs:=CoefR5[i,1]+CoefR5[i,2]*t;
   phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
   R5:=R5+CoefR5[i,3]*cos(phs);
   end;
Dr1:=-0.00186261540;
for i:=1 to 37 do
   begin
   phs:=CoefDr1[i,1]+CoefDr1[i,2]*t;
   phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
   Dr1:=Dr1+CoefDr1[i,3]*cos(phs);
   end;
Dr2:=0.00002326801;
phs:=987331.198964+43996096.593200*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr2:=Dr2+0.00436902464*cos(phs);
phs:=515806.390409+42528822.199350*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr2:=Dr2+0.00071922760*cos(phs);
phs:=1025482.923114+45463370.987050*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr2:=Dr2+0.00049766792*cos(phs);
phs:=798121.956683+87992193.186400*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr2:=Dr2+0.00043220894*cos(phs);
phs:=1229978.211253+1467274.393850*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr2:=Dr2+0.00029645554*cos(phs);
phs:=847069.620402+89459467.580250*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr2:=Dr2+0.00004141650*cos(phs);
phs:=510563.133979+41061547.805501*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr2:=Dr2+0.00004720909*cos(phs);
phs:=638948.604664+131988289.779600*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr2:=Dr2+0.00003789370*cos(phs);
phs:=283008.203341+21264411.099675*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr2:=Dr2+0.00002963990*cos(phs);
phs:=587990.258182+86524918.792550*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr2:=Dr2+0.00002556363*cos(phs);
phs:=1294494.943440+22731685.493525*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr2:=Dr2+0.00002208457*cos(phs);
phs:=1207774.976312+2934548.787699*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr2:=Dr2+0.00002187621*cos(phs);
phs:=1015748.187877+46930645.380899*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr2:=Dr2+0.00001956896*cos(phs);

Dr3:=0.00002326801;
phs:=1127015.272107+66727782.086725*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr3:=Dr3+0.00000923840*cos(phs);
phs:=612774.126791+19797136.705826*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr3:=Dr3+0.00000705936*cos(phs);
phs:=851572.877599+85057644.398701*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr3:=Dr3+0.00000546115*cos(phs);
phs:=623304.658702+43996096.593200*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr3:=Dr3+0.00020315005*cos(phs);
phs:=658282.177649+45463370.987050*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr3:=Dr3+0.00008923581*cos(phs);
phs:=897612.642360+42528822.199350*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr3:=Dr3+0.00006908677*cos(phs);
phs:=871276.830326+1467274.393850*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr3:=Dr3+0.00004087129*cos(phs);
phs:=414708.688779+87992193.186400*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr3:=Dr3+0.00003879041*cos(phs);
phs:=867055.443390+41061547.805501*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr3:=Dr3+0.00001070788*cos(phs);
phs:=470994.068291+89459467.580250*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr3:=Dr3+0.00000907332*cos(phs);
phs:=654805.305427+46930645.380899*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr3:=Dr3+0.00000606121*cos(phs);
phs:=852813.708567+2934548.787699*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr3:=Dr3+0.00000596639*cos(phs);
phs:=242043.444379+131988289.779600*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr3:=Dr3+0.00000483181*cos(phs);
phs:=291863.559092+45463370.987050*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;

Dr4:=0.00001202050*cos(phs);
phs:=239583.936320+43996096.593200*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr4:=Dr4+0.00000707796*cos(phs);
phs:=1287037.871749+42528822.199350*t;
phs:=pi*(phs-1296000.0*int(phs/1296000.0))/648000.0;
Dr4:=Dr4+0.00000516121*cos(phs);

R5:=UA*(R5+t*(Dr1+t*(Dr2+t*(Dr3+t*Dr4))));
Result:=R5;
end;

procedure Saturne(jd:double;var d5,ad5,dc5,x0,y0,z0,x5,y5,z5,eps,lg5,b5,lg0,r5:Double);
var
xa,ya,za,xb,yb,zb,xc,yc,zc,xd,yd,zd:extended;
lp:Longint;
t:Double;
deps,dpsi:Double;
dt,cfi,cfe,cfs,pr5,dm5:Double;
begin
t:=(jd-2451546)/365250;
CalcNut(t,deps,dpsi);
eps:=pi*(deps+84381.448+t*((1.813*t-0.059)*t-468.15))/648000;
Terre(t,dpsi,eps,x0,y0,z0,lg0);
lg5:=Calclg5(t);
b5:=Calcb5(t);
r5:=Calcr5(t);
x5:=r5*cos(lg5+(pi*dpsi/648000))*cos(b5);
y5:=r5*(sin(lg5+(pi*dpsi/648000))*cos(b5)*cos(eps)-sin(b5)*sin(eps));
z5:=r5*(sin(lg5+(pi*dpsi/648000))*cos(b5)*sin(eps)+sin(b5)*cos(eps));
xa:=x5-x0;
ya:=y5-y0;
za:=z5-z0;
t:=(jd-2451544)/365250;
CalcNut(t,deps,dpsi);
eps:=pi*(deps+84381.448+t*((1.813*t-0.059)*t-468.15))/648000;
Terre(t,dpsi,eps,x0,y0,z0,lg0);
lg5:=Calclg5(t);
b5:=Calcb5 (t);
r5:=Calcr5(t);
x5:=r5*cos(lg5+(pi*dpsi/648000))*cos(b5);
y5:=r5*(sin(lg5+(pi*dpsi/648000))*cos(b5)*cos(eps)-sin(b5)*sin(eps));
z5:=r5*(sin(lg5+(pi*dpsi/648000))*cos(b5)*sin(eps)+sin(b5)*cos(eps));
xc:=x5-x0;
yc:=y5-y0;
zc:=z5-z0;
t:=(jd-2451545)/365250;
CalcNut(t,deps,dpsi);
eps:=pi*(deps+84381.448+t*((1.813*t-0.059)*t-468.15))/648000;
Terre(t,dpsi,eps,x0,y0,z0,lg0);
lg5:=Calclg5(t);
b5:=Calcb5(t);
r5:=Calcr5(t);
x5:=r5*cos(lg5+(pi*dpsi/648000))*cos(b5);
y5:=r5*(sin(lg5+(pi*dpsi/648000))*cos(b5)*cos(eps)-sin(b5)*sin(eps));
z5:=r5*(sin(lg5+(pi*dpsi/648000))*cos(b5)*sin(eps)+sin(b5)*cos(eps));
xb:=x5-x0;
yb:=y5-y0;
zb:=z5-z0;
xd:=xb;
yd:=yb;
zd:=zb;
for lp:=1 to MAXITER do
   begin
   dt:=sqrt(xd*xd+yd*yd+zd*zd)/JLM;
   cfi:=dt*(dt+1)/2;
   cfe:=1-dt*dt;
   cfs:=dt*(dt-1)/2;
   xd:=cfi*xa+cfe*xb+cfs*xc-x0;
   yd:=cfi*ya+cfe*yb+cfs*yc-y0;
   zd:=cfi*za+cfe*zb+cfs*zc-y0;
   end;
dt:=sqrt(xd*xd+yd*yd+zd*zd)/JLM;
cfi:=dt*(dt+1)/2;
cfe:=1-dt*dt;
cfs:=dt*(dt-1)/2;
x5:=cfi*xa+cfe*xb+cfs*xc;
y5:=cfi*ya+cfe*yb+cfs*yc;
z5:=cfi*za+cfe*zb+cfs*zc;
if (x5<>0) then ad5:=arctan(y5/x5)*12/pi else ad5:=6*abs(y5)/y5;
if (x5<0) then ad5:=ad5+12;
if (ad5<0) then ad5:=ad5+24;
dc5:=arctan(z5/sqrt(x5*x5+y5*y5))*180/pi;
d5:=sqrt(x5*x5+y5*y5+z5*z5);
pr5:=648000*arctan(REQT/sqrt(d5*d5-REQT))/pi;
dm5:=1296000*arctan(60268/sqrt(d5*d5-3632231824.0))/pi;
end;

procedure SatPhys(qu:TDateTime;var ad,dc,aph,lc1,lc2,bc,dae,dap,th0,ap,Apl:double);
var
ga,pa,fil,dlg,l,l1,l3,b,x,y,z,u,v,w,w1,w3,xs,ys,zs,us,vs,ws:Double;
s,fev,th,at,elg,a0,d0,aas,ds,ai,di,mrg,p,q,lgp,ecl:Double;
dclv,dclh,acd,bcd,ccd,crd,dbd,fel,lc3,ls1,ls3,bs:Double;
iis:Longint;
jd:Double;
t:Double;
d5,x0,y0,z0,x5,y5,z5,eps,lg5,b5,lg0,r5:Double;
wrk:Double;
cor:Longint;
begin
apl:=13591/15067;
jd:=jj(qu);
t:=(jd-2451545.0)/36525.0;
a0:=pi*(40589-36*t)/180000;
d0:=pi*(83537-4*t)/180000;
ReducPole(a0,d0,jd);
Saturne(jd,d5,ad,dc,x0,y0,z0,x5,y5,z5,eps,lg5,b5,lg0,r5);
w1:=227.2037+844.3*(jd-2451545-(d5/JLM));
w3:=38.90+810.7939024*(jd-2451545-(d5/JLM));
ai:=pi*ad/12;
di:=pi*dc/180;
x:=x0+x5;
y:=y0+y5;
z:=z0+z5;
if (x<>0) then aas:=arctan(y/x) else aas:=-pi*y/abs(2*y);
if (x>0) then aas:=aas+pi;
if (aas<0) then aas:=aas+2*pi;
ds:=-arctan(z/sqrt(x*x+y*y));
x:=cos(ai-a0)*sin(d0)*cos(di)-sin(di)*cos(d0);
y:=sin(ai-a0)*cos(di);
z:=-(cos(ai-a0)*cos(d0)*cos(di)+sin(di)*sin(d0));
u:=sin(d0)*cos(di)-cos(ai-a0)*sin(di)*cos(d0);
v:=sin(a0-ai)*cos(d0);
xs:=sin(ds)*cos(d0)-cos(a0-aas)*sin(d0)*cos(ds);
ys:=sin(a0-aas)*cos(ds);
zs:=cos(a0-aas)*cos(d0)*cos(ds)+sin(ds)*sin(d0);
us:=sin(ds)*cos(di)-cos(ds)*sin(di)*cos(aas-ai);
vs:=sin(aas-ai)*cos(ds);
ws:=-(cos(ds)*cos(di)*cos(aas-ai)+sin(ds)*sin(di));
if (x<>0) then at:=arctan(y/x)*180/pi else at:=90*y/abs(y);
if (x<0) then at:=at+180;
lc1:=w1-at-90;
lc1:=lc1-360*int(lc1/360);
if (lc1<0) then lc1:=lc1+360;
lc3:=w3-at-90;
lc3:=lc3-360*int(lc3/360);
if (lc3<0) then lc3:=lc3+360;
wrk:=sqrt(x*x+y*y);
if (wrk<>0) then bc:=arctan(z/wrk)*180/pi else bc:=90*z/abs(z);
if (u<>0) then ap:=arctan(v/u)*180/pi else if (v=0) then ap:=0 else ap:=90*v/abs(v);
if (u<0) then ap:=ap+180;
if (ap<0) then ap:=ap+360;
if (xs<>0) then at:=arctan(ys/xs)*180/pi else at:=90*ys/abs(ys);
if (xs<0) then at:=at+180;
ls1:=w1-at-90;
ls1:=ls1-360*int(ls1/360);
if (ls1<0) then ls1:=ls1+360;
ls3:=w3-at-90;
ls3:=ls3-360*int(ls3/360);
if (ls3<0) then ls3:=ls3+360;
wrk:=sqrt(xs*xs+ys*ys);
if (wrk<>0) then bs:=arctan(zs/wrk)*180/pi else bs:=90*zs/abs(zs);
if (us<>0) then th0:=arctan(vs/us)*180/pi else if (vs=0) then th0:=0 else th0:=90*vs/abs(vs);
if (us<0) then th0:=th0+180;
th0:=th0-180;
if (th0<0) then th0:=th0+360;
fil:=(1+ws)/2;
dae:=arctan(60268/sqrt(d5*d5-3632231824.0))*1296000/pi;
wrk:=bc*pi/180;
dap:=60268*sqrt(sin(wrk)*sin(wrk)+apl*apl*cos(wrk)*cos(wrk));
dap:=arctan(dap/sqrt(d5*d5-dap*dap))*1296000/pi;
wrk:=abs(sin(pi*bc/180));
ga:=arctan(137000/sqrt(d5*d5-18769000000.0))*1296000/pi;
pa:=ga*wrk;
x:=y5*z0-y0*z5;
u:=x0*z5-x5*z0;
v:=x5*y0-x0*y5;
y:=u*cos(eps)+v*sin(eps);
z:=v*cos(eps)-u*sin(eps);
u:=z*sqrt(x*x+y*y+z*z)/abs(z);
v:=x5*(x5+x0)+y5*(y5+y0)+z5*(z5+z0);
if (v<>0) then aph:=180*arctan(u/v)/pi else aph:=90*u/abs(u);
if (v<0) then aph:=aph+180;
if (aph>180) then aph:=aph-360;
w:=-(x0*x5+y0*y5+z0*z5);
if (w<>0) then elg:=180*arctan(u/w)/pi else elg:=90*u/abs(u);
if (w<0) then elg:=elg+180;
if (elg>180) then elg:=elg-360;
v:=x5*(x5+x0)+y5*(y5+y0)*cos(eps)*cos(eps)+z5*(z5+z0)*sin(eps)*sin(eps)+(z5*(y5+y0)+y5*(z5+z0))*cos(eps)*sin(eps);
if (v<>0) then dlg:=180*arctan(z/v)/pi else dlg:=90*z/abs(z);
if (v<0) then dlg:=dlg+180;
if (dlg>180) then dlg:=dlg-360;
w:=-(x5*x0+y5*y0*cos(eps)*cos(eps)+z5*z0*sin(eps)*sin(eps)+(z5*y0+y5*z0)*cos(eps)*sin(eps));
if (w<>0) then ecl:=180*arctan(z/w)/pi else ecl:=90*z/abs(z);
if (w<0) then ecl:=ecl+180;
if (ecl>180) then ecl:=ecl-360;
q:=(-8717474-t*(2914183-t*(157351+t*(12382-t*(753+28*t)))))/1000000000.0;
p:=(19891473-t*(1633044+t*(223323-t*(11193+t*(588-55*t)))))/1000000000.0;
xs:=cos(a0)*cos(d0);
ys:=sin(a0)*cos(d0)*cos(eps)+sin(d0)*sin(eps);
zs:=sin(d0)*cos(eps)-sin(a0)*cos(d0)*sin(eps);
us:=2*p*sqrt(1-p*p-q*q);
vs:=-2*q*sqrt(1-p*p-q*q);
ws:=1-2*p*p-2*q*q;
x:=zs*vs-ys*ws;
y:=xs*ws-zs*us;
z:=ys*us-xs*vs;
wrk:=sqrt(x*x+y*y+z*z);
x:=x/wrk;
y:=y/wrk;
z:=z/wrk;
u:=z*vs-y*ws;
v:=x*ws-z*us;
w:=y*us-x*vs;
p:=(x*cos(lg5)+y*sin(lg5))*cos(b5)+z*sin(b5);
q:=(u*cos(lg5)+v*sin(lg5))*cos(b5)+w*sin(b5);
if (p<>0) then lgp:=arctan(q/p)*180/pi else lgp:=90*q/abs(q);
if (p<0) then lgp:=lgp+180;
if (lgp<0) then lgp:=lgp+360;
iis:=trunc(lgp/90) mod 4;
cor:=trunc(jd+1.5) mod 7;

// writeln('Angle de phase (i)                                         : ',aph:8:4);
// writeln('Angle de position du milieu de la phase (th‚ta)            : ',th0:8:4);
// writeln('Fraction illumin‚e du disque (k)                           : ',fil:8:6);
// writeln('Angle de position du p“le (P)                              : ',ap:8:4);
// writeln('Longitudes saturnicentriques de la Terre (L0I et L0III)    : ',lc1:8:4,lc3:9:4);
// writeln('Latitude saturnicentrique de la Terre                      : ',bc:8:4);
// writeln('Longitudes saturnicentriques du Soleil (SystŠmes I et III) : ',ls1:8:4,ls3:9:4);
// writeln('Latitude saturnicentrique du Soleil                        : ',bs:8:4);
// writeln('DiamŠtre apparent ‚quatorial (secondes d''arc)              : ',dae:8:4);
// writeln('DiamŠtre apparent polaire (secondes d''arc)                 : ',dap:8:4);
// writeln('Position ‚cliptique h‚liocentrique (lambda et b‚ta)        : ',lg5*180/pi:8:4,b5*180/pi:8:4);
// writeln('Longitude ‚cliptique de la Terre                           : ',lg0*180/pi:8:4);
// write('Longitude saisonniŠre de Saturne                           : ',lgp:8:4);
// case is of
//   0 : writeln(' (Pri).');
//   1 : writeln(' (Et‚).');
//   2 : writeln(' (Aut).');
//   3 : writeln(' (Hiv).');
//  end;
// writeln('Distances au Soleil (r) et … la Terre (delta), en UA       : ',r5/UA:9:5,d5/UA:9:5);
// writeln('Elongation et ‚longation ‚cliptique                        : ',elg:8:3,ecl:9:3);
// writeln('Angle de phase ‚cliptique                                  : ',dlg:8:4);
// writeln('Axes apparents externes de l''anneau A                      : ',ga:8:2,pa:8:2);
// writeln('Axes apparents internes de l''anneau A                      : ',0.88*ga:8:2,0.88*pa:8:2);
// writeln('Axes apparents externes de l''anneau B                      : ',0.85*ga:8:2,0.85*pa:8:2);
// writeln('Axes apparents internes de l''anneau B                      : ',0.65*ga:8:2,0.65*pa:8:2);
// writeln('Axes apparents internes de l''anneau C                      : ',0.52*ga:8:2,0.52*pa:8:2);
end;

begin
end.
